<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rekap Absensi Admin - SDN Rawabuntu 03</title>
    <link rel="stylesheet" href="style_main.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        .filter-group { background: white; padding: 15px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        input[type="date"], select { padding: 12px; border: 1px solid #ddd; border-radius: 8px; width: 100%; background: white; margin-top: 5px; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 12px; }
        th { background: #1e293b; color: white; padding: 10px; border: 1px solid #334155; }
        td { border: 1px solid #e2e8f0; padding: 8px; text-align: center; }
        .text-left { text-align: left; padding-left: 10px; }
        .btn-download { background: #10b981; color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-weight: bold; width: 100%; margin-top: 10px; }
        
        /* New Styles for Delete Feature */
        .btn-danger { 
            background: #ef4444; 
            color: white; 
            border: none; 
            padding: 12px; 
            border-radius: 8px; 
            cursor: pointer; 
            font-weight: bold; 
            width: 100%; 
            margin-top: 10px;
            transition: all 0.3s ease;
        }
        .btn-danger:hover {
            background: #dc2626;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }
        .btn-danger:disabled {
            background: #fca5a5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .danger-zone {
            border: 2px solid #ef4444;
            background: #fef2f2;
            padding: 15px;
            border-radius: 12px;
            margin-top: 20px;
        }
        .danger-zone h4 {
            color: #dc2626;
            margin-top: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .confirmation-dialog {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            z-index: 1000;
            max-width: 400px;
            width: 90%;
        }
        .confirmation-dialog h4 {
            color: #dc2626;
            margin-top: 0;
        }
        .confirmation-dialog p {
            margin: 15px 0;
            color: #4b5563;
        }
        .confirmation-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 999;
        }
        .loading-delete {
            display: none;
            text-align: center;
            padding: 10px;
            color: #dc2626;
            font-weight: bold;
        }
        .loading-delete i {
            margin-right: 10px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .status-message {
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
            display: none;
            text-align: center;
            font-weight: bold;
        }
        .status-success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }
        .status-error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fca5a5;
        }
        .warning-text {
            color: #dc2626;
            font-size: 12px;
            margin-top: 5px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
    </style>
</head>
<body>
    <header class="top-bar">
        <a href="index.html" style="color:white; text-decoration:none;"><i class="fa-solid fa-arrow-left"></i> Kembali</a>
        <h3>Rekap Absensi Global</h3>
    </header>

    <div class="container">
        <div class="filter-group">
            <div style="display:flex; gap:10px; margin-bottom: 15px;">
                <div style="flex:1;">
                    <label><b>Dari Tanggal:</b></label>
                    <input type="date" id="tglMulai">
                </div>
                <div style="flex:1;">
                    <label><b>Sampai Tanggal:</b></label>
                    <input type="date" id="tglSelesai">
                </div>
            </div>
            <label><b>Pilih User (Guru):</b></label>
            <select id="pilihUser"><option value="SEMUA">-- Tampilkan Semua Guru --</option></select>
            <br><br>
            <label><b>Pilih Kelas:</b></label>
            <select id="pilihKelas"><option value="SEMUA">-- Tampilkan Semua Kelas --</option></select>
            
            <button onclick="prosesRekap()" class="btn-primary" style="width:100%; margin-top:20px;">TAMPILKAN DATA</button>
            <button onclick="unduhExcel()" class="btn-download" id="btnExport" style="display:none;"><i class="fa-solid fa-file-excel"></i> UNDUH EXCEL</button>
        </div>
        
        <!-- Danger Zone - Delete Data -->
        <div class="danger-zone" id="dangerZone" style="display:none;">
            <h4><i class="fa-solid fa-triangle-exclamation"></i> ZONA BERBAHAYA - HAPUS DATA</h4>
            <p><strong>Peringatan:</strong> Tindakan ini akan menghapus PERMANEN data absensi dalam rentang tanggal dan kelas yang dipilih.</p>
            <div class="warning-text">
                <i class="fa-solid fa-circle-exclamation"></i>
                Data yang dihapus TIDAK DAPAT dikembalikan. Pastikan Anda sudah mendownload backup.
            </div>
            <button onclick="konfirmasiHapus()" class="btn-danger" id="btnHapus">
                <i class="fa-solid fa-trash"></i> HAPUS DATA ABSENSI TERPILIH
            </button>
            <div class="loading-delete" id="loadingDelete">
                <i class="fa-solid fa-spinner"></i> Menghapus data, mohon tunggu...
            </div>
            <div class="status-message" id="statusMessage"></div>
        </div>
        
        <div id="areaTabel" class="table-responsive"></div>
    </div>

    <!-- Confirmation Dialog -->
    <div class="overlay" id="confirmationOverlay"></div>
    <div class="confirmation-dialog" id="confirmationDialog">
        <h4><i class="fa-solid fa-triangle-exclamation"></i> KONFIRMASI PENGHAPUSAN</h4>
        <p id="confirmationText">Apakah Anda yakin ingin menghapus data absensi?</p>
        <div class="confirmation-buttons">
            <button onclick="batalHapus()" style="flex:1; padding:10px; background:#6b7280; color:white; border:none; border-radius:6px; cursor:pointer;">
                BATAL
            </button>
            <button onclick="eksekusiHapus()" style="flex:1; padding:10px; background:#ef4444; color:white; border:none; border-radius:6px; cursor:pointer; font-weight:bold;">
                <i class="fa-solid fa-trash"></i> HAPUS
            </button>
        </div>
    </div>

    <script type="module">
        import { db, auth, ref, get, remove, onAuthStateChanged } from './config_firebase.js';

        const klsList = ["1A","1B","1C","1D","2A","2B","2C","2D","2E","3A","3B","3C","3D","3E","4A","4B","4C","4D","4E","4F","5A","5B","5C","5D","5E","6A","6B","6C","6D","6E"];
        let kamusSiswa = {}; // Untuk menyimpan data {id_absen: nama_siswa}
        let deleteConfig = {}; // Menyimpan konfigurasi penghapusan

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // 1. Isi Kelas
                const selKls = document.getElementById('pilihKelas');
                klsList.forEach(k => { selKls.innerHTML += `<option value="${k}">Kelas ${k}</option>`; });

                // 2. Isi Guru
                try {
                    const snapUser = await get(ref(db, 'users'));
                    const selUser = document.getElementById('pilihUser');
                    if(snapUser.exists()){
                        snapUser.forEach(u => {
                            const d = u.val();
                            if(d.role !== 'ADMIN') selUser.innerHTML += `<option value="${d.nama}">${d.nama} (${d.role})</option>`;
                        });
                    }

                    // 3. Ambil Master Data Siswa untuk memetakan ID ke Nama
                    const snapSiswa = await get(ref(db, 'siswa'));
                    if(snapSiswa.exists()){
                        snapSiswa.forEach(klsSnap => {
                            klsSnap.forEach(mhsSnap => {
                                const s = mhsSnap.val();
                                kamusSiswa[mhsSnap.key] = s.nama; // Simpan nama berdasarkan no_absen/key
                            });
                        });
                    }
                } catch (e) { console.error(e); }
            } else { window.location.href = "index.html"; }
        });

        window.prosesRekap = async function() {
            const tglAwal = document.getElementById('tglMulai').value;
            const tglAkhir = document.getElementById('tglSelesai').value;
            const klsPilihan = document.getElementById('pilihKelas').value;

            if(!tglAwal || !tglAkhir) return alert("Pilih tanggal!");

            const area = document.getElementById('areaTabel');
            area.innerHTML = "<p style='text-align:center;'>Memproses data...</p>";
            
            const snap = await get(ref(db, 'absensi'));
            
            let rekap = {};
            if(snap.exists()){
                const data = snap.val();
                Object.keys(data).forEach(tgl => {
                    if(tgl >= tglAwal && tgl <= tglAkhir){
                        Object.keys(data[tgl]).forEach(kls => {
                            if(klsPilihan === "SEMUA" || kls === klsPilihan){
                                Object.keys(data[tgl][kls]).forEach(id => {
                                    if(!rekap[id]) {
                                        // Ambil nama dari kamus, jika tidak ada pakai ID
                                        const namaSiswa = kamusSiswa[id] || "ID: " + id;
                                        rekap[id] = { id: id, nama: namaSiswa, kls: kls, H:0, S:0, I:0, A:0 };
                                    }
                                    const st = data[tgl][kls][id].status;
                                    if(st === "Hadir") rekap[id].H++;
                                    else if(st === "Sakit") rekap[id].S++;
                                    else if(st === "Ijin") rekap[id].I++;
                                    else if(st === "Alfa") rekap[id].A++;
                                });
                            }
                        });
                    }
                });
            }

            let tr = "";
            const sortedData = Object.values(rekap).sort((a, b) => a.kls.localeCompare(b.kls) || a.nama.localeCompare(b.nama));
            
            sortedData.forEach(s => {
                tr += `<tr>
                    <td class="text-left">${s.nama}</td>
                    <td>${s.kls}</td>
                    <td>${s.H}</td><td>${s.S}</td><td>${s.I}</td><td>${s.A}</td>
                </tr>`;
            });

            if(tr === "") {
                area.innerHTML = "<p style='text-align:center;'>Data tidak ditemukan.</p>";
                document.getElementById('dangerZone').style.display = 'none';
                document.getElementById('btnExport').style.display = 'none';
            } else {
                area.innerHTML = `
                <table id="tbl">
                    <thead>
                        <tr>
                            <th>Nama Siswa</th><th>Kelas</th><th>H</th><th>S</th><th>I</th><th>A</th>
                        </tr>
                    </thead>
                    <tbody>${tr}</tbody>
                </table>`;
                document.getElementById('btnExport').style.display = "block";
                document.getElementById('dangerZone').style.display = 'block';
                
                // Simpan konfigurasi untuk penghapusan
                deleteConfig = {
                    tglAwal: tglAwal,
                    tglAkhir: tglAkhir,
                    klsPilihan: klsPilihan,
                    totalData: sortedData.length
                };
            }
        }

        window.unduhExcel = function() {
            const table = document.getElementById("tbl");
            const wb = XLSX.utils.table_to_book(table, {sheet: "Rekap Absensi"});
            XLSX.writeFile(wb, "Rekap_Absensi_Nama.xlsx");
        }

        // Fungsi-fungsi untuk fitur hapus data
        window.konfirmasiHapus = function() {
            if (!deleteConfig.tglAwal || !deleteConfig.tglAkhir) {
                alert("Pilih tanggal terlebih dahulu!");
                return;
            }

            const kelasText = deleteConfig.klsPilihan === "SEMUA" ? "SEMUA KELAS" : "Kelas " + deleteConfig.klsPilihan;
            const confirmationText = `
                Anda akan menghapus data absensi:<br><br>
                <strong>Periode:</strong> ${deleteConfig.tglAwal} s/d ${deleteConfig.tglAkhir}<br>
                <strong>Kelas:</strong> ${kelasText}<br>
                <strong>Jumlah Data:</strong> ${deleteConfig.totalData} entri<br><br>
                <span style="color:#dc2626; font-weight:bold;">
                    Tindakan ini TIDAK DAPAT DIBATALKAN!
                </span>
            `;

            document.getElementById('confirmationText').innerHTML = confirmationText;
            document.getElementById('confirmationDialog').style.display = 'block';
            document.getElementById('confirmationOverlay').style.display = 'block';
        }

        window.batalHapus = function() {
            document.getElementById('confirmationDialog').style.display = 'none';
            document.getElementById('confirmationOverlay').style.display = 'none';
        }

        window.eksekusiHapus = async function() {
            // Tutup dialog
            document.getElementById('confirmationDialog').style.display = 'none';
            document.getElementById('confirmationOverlay').style.display = 'none';
            
            // Tampilkan loading
            document.getElementById('loadingDelete').style.display = 'block';
            document.getElementById('btnHapus').disabled = true;
            document.getElementById('statusMessage').style.display = 'none';

            try {
                const { tglAwal, tglAkhir, klsPilihan } = deleteConfig;
                
                // Ambil data absensi untuk periode yang dipilih
                const snap = await get(ref(db, 'absensi'));
                
                if (!snap.exists()) {
                    throw new Error("Tidak ada data absensi");
                }

                const data = snap.val();
                let totalDeleted = 0;
                let deletePromises = [];

                // Loop melalui tanggal dan kelas untuk menghapus data
                Object.keys(data).forEach(tgl => {
                    if (tgl >= tglAwal && tgl <= tglAkhir) {
                        Object.keys(data[tgl]).forEach(kls => {
                            if (klsPilihan === "SEMUA" || kls === klsPilihan) {
                                // Hapus data untuk tanggal dan kelas tertentu
                                const deleteRef = ref(db, `absensi/${tgl}/${kls}`);
                                deletePromises.push(
                                    remove(deleteRef).then(() => {
                                        totalDeleted += Object.keys(data[tgl][kls] || {}).length;
                                    })
                                );
                            }
                        });
                    }
                });

                // Tunggu semua proses penghapusan selesai
                await Promise.all(deletePromises);

                // Tampilkan status sukses
                document.getElementById('loadingDelete').style.display = 'none';
                const statusEl = document.getElementById('statusMessage');
                statusEl.className = 'status-message status-success';
                statusEl.innerHTML = `<i class="fa-solid fa-check-circle"></i> Berhasil menghapus ${totalDeleted} data absensi!`;
                statusEl.style.display = 'block';

                // Reset data yang ditampilkan
                setTimeout(() => {
                    prosesRekap(); // Refresh data setelah dihapus
                    document.getElementById('btnHapus').disabled = false;
                    setTimeout(() => {
                        statusEl.style.display = 'none';
                    }, 5000);
                }, 2000);

            } catch (error) {
                console.error("Gagal menghapus data:", error);
                document.getElementById('loadingDelete').style.display = 'none';
                document.getElementById('btnHapus').disabled = false;
                
                const statusEl = document.getElementById('statusMessage');
                statusEl.className = 'status-message status-error';
                statusEl.innerHTML = `<i class="fa-solid fa-circle-exclamation"></i> Gagal menghapus data: ${error.message}`;
                statusEl.style.display = 'block';
            }
        }
    </script>
</body>
</html>