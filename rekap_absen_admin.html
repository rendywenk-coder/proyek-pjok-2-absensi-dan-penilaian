
<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rekap Absensi Admin - SDN Rawabuntu 03</title>
    <link rel="stylesheet" href="style_main.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { background: #f0f2f5; font-family: 'Poppins', sans-serif; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; }
        
        .header-card { background: white; padding: 25px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .controls { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-top: 15px; }
        
        label { font-size: 12px; font-weight: 600; color: #64748b; margin-bottom: 5px; display: block; }
        input, select, button { padding: 12px; border-radius: 8px; border: 1px solid #ddd; width: 100%; font-size: 14px; box-sizing: border-box; }
        button { cursor: pointer; background: #1e40af; color: white; border: none; font-weight: 500; transition: 0.3s; }
        button:hover { background: #1e3a8a; }
        
        /* Table Styling */
        .table-responsive { overflow-x: auto; background: white; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-top: 20px; }
        table { width: 100%; border-collapse: collapse; min-width: 1000px; }
        th, td { padding: 12px 15px; border-bottom: 1px solid #eee; text-align: center; font-size: 14px; }
        th { background: #f8fafc; color: #1e293b; font-weight: 600; white-space: nowrap; border-bottom: 2px solid #e2e8f0; }
        
        /* Badges */
        .badge { padding: 5px 12px; border-radius: 20px; font-weight: bold; font-size: 13px; }
        .bg-h { background: #dcfce7; color: #166534; }
        .bg-s { background: #fff7ed; color: #d97706; }
        .bg-i { background: #eff6ff; color: #2563eb; }
        .bg-a { background: #fef2f2; color: #dc2626; }
        
        .loading { display: none; text-align: center; padding: 50px; }

        /* Danger Zone Style */
        .danger-zone {
            margin-top: 20px; padding: 15px; border: 1px solid #fca5a5; 
            background: #fef2f2; border-radius: 8px; display: flex; align-items: center; gap: 10px; flex-wrap: wrap;
        }
        .btn-delete { background: #ef4444; color: white; }
        .btn-delete:hover { background: #dc2626; }
        .btn-delete:disabled { background: #cbd5e1; cursor: not-allowed; }
        
        /* Info Box */
        .info-box {
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
            border-left: 4px solid #3b82f6;
            border-radius: 8px;
            padding: 12px 16px;
            margin-top: 15px;
            font-size: 12px;
            color: #1e40af;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }
        
        /* Filter Guru Style */
        .guru-filter {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }
        
        .guru-filter select {
            width: 100%;
        }
        
        .filter-label {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 11px;
            color: #64748b;
        }
        
        .filter-label i {
            font-size: 14px;
        }
        
        /* Guru Badge */
        .guru-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 8px;
        }
        
        .guru-akademik { background: #dbeafe; color: #1e40af; }
        .guru-pjok { background: #dcfce7; color: #166534; }
        .guru-pai { background: #fef3c7; color: #92400e; }
        
        /* Summary Card */
        .summary-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .summary-item {
            text-align: center;
            padding: 15px;
            border-radius: 8px;
            min-width: 120px;
        }
        
        .summary-item.hadir { background: #dcfce7; color: #166534; }
        .summary-item.sakit { background: #fff7ed; color: #d97706; }
        .summary-item.ijin { background: #eff6ff; color: #2563eb; }
        .summary-item.alfa { background: #fef2f2; color: #dc2626; }
        
        .summary-value {
            font-size: 24px;
            font-weight: 700;
            display: block;
        }
        
        .summary-label {
            font-size: 12px;
            opacity: 0.8;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .controls {
                grid-template-columns: 1fr;
            }
            
            .summary-card {
                flex-direction: column;
                align-items: stretch;
            }
            
            .summary-item {
                min-width: 100%;
                margin-bottom: 10px;
            }
        }
        
        /* Progress Bar */
        .progress-container {
            margin-top: 15px;
            background: #e2e8f0;
            border-radius: 10px;
            overflow: hidden;
            height: 8px;
            display: none;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #3b82f6, #1e40af);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        /* Status Messages */
        .status-message {
            padding: 10px 15px;
            border-radius: 8px;
            margin-top: 10px;
            font-size: 13px;
            display: none;
            align-items: center;
            gap: 10px;
        }
        
        .status-success {
            background: #dcfce7;
            color: #166534;
            border-left: 4px solid #10b981;
        }
        
        .status-error {
            background: #fef2f2;
            color: #dc2626;
            border-left: 4px solid #ef4444;
        }
        
        .status-warning {
            background: #fffbeb;
            color: #92400e;
            border-left: 4px solid #f59e0b;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header-card">
        <h2 style="color: #1e40af; margin-top:0;"><i class="fa-solid fa-calendar-check"></i> Laporan Absensi Admin</h2>
        <p style="color: #64748b; margin-bottom: 0;">Rekapitulasi kehadiran siswa berdasarkan mata pelajaran dan rentang tanggal.</p>
        
        <div class="controls">
            <div>
                <label><i class="fa-solid fa-users"></i> Pilih Kelas</label>
                <select id="pilihKelas">
                   <option value="">-- Pilih Kelas --</option>
                   <option value="1A">Kelas 1A</option><option value="1B">Kelas 1B</option><option value="1C">Kelas 1C</option><option value="1D">Kelas 1D</option>
                   <option value="2A">Kelas 2A</option><option value="2B">Kelas 2B</option><option value="2C">Kelas 2C</option><option value="2D">Kelas 2D</option><option value="2E">Kelas 2E</option>
                   <option value="3A">Kelas 3A</option><option value="3B">Kelas 3B</option><option value="3C">Kelas 3C</option><option value="3D">Kelas 3D</option><option value="3E">Kelas 3E</option>
                   <option value="4A">Kelas 4A</option><option value="4B">Kelas 4B</option><option value="4C">Kelas 4C</option><option value="4D">Kelas 4D</option><option value="4E">Kelas 4E</option><option value="4F">Kelas 4F</option>
                   <option value="5A">Kelas 5A</option><option value="5B">Kelas 5B</option><option value="5C">Kelas 5C</option><option value="5D">Kelas 5D</option><option value="5E">Kelas 5E</option>
                   <option value="6A">Kelas 6A</option><option value="6B">Kelas 6B</option><option value="6C">Kelas 6C</option><option value="6D">Kelas 6D</option><option value="6E">Kelas 6E</option>
                </select>
            </div>
            <div>
                <label><i class="fa-solid fa-chalkboard-teacher"></i> Mata Pelajaran</label>
                <select id="pilihMapel">
                    <option value="semua">Semua Mata Pelajaran</option>
                    <option value="akademik">Akademik (Guru Kelas)</option>
                    <option value="pjok">PJOK (Penjas)</option>
                    <option value="pai">PAI (Agama)</option>
                </select>
            </div>
            <div>
                <label><i class="fa-solid fa-calendar-day"></i> Dari Tanggal</label>
                <input type="date" id="tglMulai">
            </div>
            <div>
                <label><i class="fa-solid fa-calendar-week"></i> Sampai Tanggal</label>
                <input type="date" id="tglSelesai">
            </div>
            <div style="display: flex; align-items: flex-end; gap: 10px;">
                <button onclick="prosesRekap()" style="flex: 1;"><i class="fa-solid fa-filter"></i> Tampilkan</button>
                <button onclick="exportExcel()" style="background:#10b981; flex: 1;"><i class="fa-solid fa-file-excel"></i> Excel</button>
            </div>
            <div style="display: flex; align-items: flex-end;">
                <button onclick="window.location.href='index.html'" style="background:#64748b;"><i class="fa-solid fa-arrow-left"></i> Kembali</button>
            </div>
        </div>

        <div class="info-box">
            <i class="fa-solid fa-circle-info"></i>
            <div>
                <strong>Fitur Filter Baru:</strong> Sekarang Anda bisa filter berdasarkan mata pelajaran. 
                Pilih "Semua Mata Pelajaran" untuk melihat rekap lengkap, atau pilih spesifik untuk melihat per mata pelajaran.
            </div>
        </div>

        <div class="danger-zone">
            <input type="checkbox" id="confirmDelete" style="width: 20px; height: 20px;">
            <label for="confirmDelete" style="margin:0; color: #b91c1c; cursor:pointer;">Saya yakin ingin menghapus data absensi sesuai filter di atas.</label>
            <button id="btnHapus" onclick="hapusDataAbsensi()" class="btn-delete" disabled style="width: auto; padding: 10px 20px;">
                <i class="fa-solid fa-trash"></i> Hapus Data
            </button>
        </div>
        
        <!-- Progress Bar -->
        <div class="progress-container" id="deleteProgress">
            <div class="progress-bar" id="deleteProgressBar"></div>
        </div>
        
        <!-- Status Message -->
        <div id="statusMessage" class="status-message">
            <i class="fa-solid fa-circle-info"></i>
            <span id="statusText">Status akan muncul di sini</span>
        </div>
    </div>

    <!-- Summary Statistics -->
    <div id="summaryContainer" style="display: none;">
        <div class="summary-card">
            <div class="summary-item hadir">
                <span class="summary-value" id="totalHadir">0</span>
                <span class="summary-label">Total Hadir</span>
            </div>
            <div class="summary-item sakit">
                <span class="summary-value" id="totalSakit">0</span>
                <span class="summary-label">Total Sakit</span>
            </div>
            <div class="summary-item ijin">
                <span class="summary-value" id="totalIjin">0</span>
                <span class="summary-label">Total Ijin</span>
            </div>
            <div class="summary-item alfa">
                <span class="summary-value" id="totalAlfa">0</span>
                <span class="summary-label">Total Alfa</span>
            </div>
            <div style="text-align: right;">
                <div style="font-size: 12px; color: #64748b;">Mata Pelajaran: <span id="currentMapelDisplay" style="font-weight: 600; color: #1e40af;">Semua</span></div>
                <div style="font-size: 11px; color: #94a3b8; margin-top: 5px;" id="dateRangeDisplay"></div>
            </div>
        </div>
    </div>

    <div id="loading" class="loading">
        <i class="fa-solid fa-circle-notch fa-spin fa-3x" style="color: #1e40af;"></i>
        <p style="margin-top: 15px;">Memproses Data...</p>
    </div>

    <div class="table-responsive">
        <table id="rekapTable">
            <thead>
                <tr>
                    <th rowspan="2" style="width: 50px;">No</th>
                    <th rowspan="2" style="text-align:left;">Nama Siswa</th>
                    <th colspan="4" style="background:#f1f5f9;">Total Kehadiran</th>
                    <th rowspan="2" style="width: 100px;">Persentase</th>
                    <th rowspan="2" style="width: 120px;">Detail</th>
                </tr>
                <tr>
                    <th style="color:#166534; background:#dcfce7;">Hadir</th>
                    <th style="color:#d97706; background:#fff7ed;">Sakit</th>
                    <th style="color:#2563eb; background:#eff6ff;">Ijin</th>
                    <th style="color:#dc2626; background:#fef2f2;">Alfa</th>
                </tr>
            </thead>
            <tbody id="tableBody">
                <tr><td colspan="8" style="padding:40px; color:#94a3b8;">Silakan pilih Kelas, Mata Pelajaran, dan Rentang Tanggal lalu klik Tampilkan Data.</td></tr>
            </tbody>
        </table>
    </div>
</div>

<script type="module">
    import { 
        db, auth, onAuthStateChanged, ref, get, remove, update,
        checkWritePermission, getCurrentUserId, getUserData
    } from './config_firebase.js';

    document.getElementById('confirmDelete').addEventListener('change', function() {
        document.getElementById('btnHapus').disabled = !this.checked;
    });

    let currentUserRole = null;
    let currentUserId = null;
    
    onAuthStateChanged(auth, async (user) => {
        if (!user) {
            alert("Harap login sebagai Admin.");
            window.location.href = 'index.html';
            return;
        }
        
        currentUserId = user.uid;
        
        try {
            const userData = await getUserData(user.uid);
            if (userData) {
                currentUserRole = userData.role;
                
                if (currentUserRole !== 'ADMIN') {
                    alert("Hanya admin yang bisa mengakses halaman ini.");
                    window.location.href = 'index.html';
                }
            }
        } catch (error) {
            console.error("Error getting user data:", error);
        }
    });

    const today = new Date();
    const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
    document.getElementById('tglSelesai').valueAsDate = today;
    document.getElementById('tglMulai').valueAsDate = firstDay;

    window.prosesRekap = prosesRekap;
    window.exportExcel = exportExcel;
    window.hapusDataAbsensi = hapusDataAbsensi;
    window.tampilkanDetail = tampilkanDetail;

    // Fungsi untuk menampilkan status message
    function showStatus(message, type = 'info') {
        const statusEl = document.getElementById('statusMessage');
        const statusText = document.getElementById('statusText');
        
        statusText.textContent = message;
        statusEl.className = `status-message status-${type}`;
        statusEl.style.display = 'flex';
        
        // Auto hide setelah 5 detik untuk tipe success
        if (type === 'success') {
            setTimeout(() => {
                statusEl.style.display = 'none';
            }, 5000);
        }
    }

    async function prosesRekap() {
        const kelas = document.getElementById('pilihKelas').value;
        const mapel = document.getElementById('pilihMapel').value;
        const tglMulai = document.getElementById('tglMulai').value;
        const tglSelesai = document.getElementById('tglSelesai').value;

        if (!kelas) {
            alert("Mohon pilih kelas terlebih dahulu!");
            return;
        }

        document.getElementById('loading').style.display = 'block';
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '';
        document.getElementById('summaryContainer').style.display = 'none';

        try {
            const siswaSnap = await get(ref(db, `siswa/${kelas}`));
            if (!siswaSnap.exists()) {
                document.getElementById('loading').style.display = 'none';
                tbody.innerHTML = '<tr><td colspan="8">Data siswa belum ada.</td></tr>';
                return;
            }

            // Hitung rekap absensi dengan filter mata pelajaran
            const rekap = await hitungAbsensiRange(kelas, tglMulai, tglSelesai, mapel);
            
            // Update summary display
            document.getElementById('currentMapelDisplay').textContent = getMapelDisplayName(mapel);
            document.getElementById('dateRangeDisplay').textContent = `${tglMulai} s/d ${tglSelesai}`;
            
            // Hitung total untuk summary
            let totalHadir = 0, totalSakit = 0, totalIjin = 0, totalAlfa = 0;
            
            const siswaList = Object.values(siswaSnap.val()).sort((a,b) => a.nama.localeCompare(b.nama));
            let no = 1;

            siswaList.forEach(siswa => {
                const safeId = siswa.nama.replace(/[.#$/[\]]/g, '_');
                const data = rekap[safeId] || { h: 0, s: 0, i: 0, a: 0 };
                
                // Hitung total untuk summary
                totalHadir += data.h;
                totalSakit += data.s;
                totalIjin += data.i;
                totalAlfa += data.a;
                
                const totalDataMasuk = data.h + data.s + data.i + data.a;
                let persentase = 0;
                if (totalDataMasuk > 0) {
                    persentase = Math.round((data.h / totalDataMasuk) * 100);
                }

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${no++}</td>
                    <td style="text-align:left; font-weight:500;">
                        ${siswa.nama}
                        ${getMapelBadge(mapel)}
                    </td>
                    <td><span class="badge bg-h">${data.h}</span></td>
                    <td><span class="badge bg-s">${data.s}</span></td>
                    <td><span class="badge bg-i">${data.i}</span></td>
                    <td><span class="badge bg-a">${data.a}</span></td>
                    <td style="font-weight:bold; color: ${persentase < 70 ? 'red' : persentase < 80 ? 'orange' : 'green'}">
                        ${totalDataMasuk > 0 ? persentase + '%' : '0%'}
                    </td>
                    <td>
                        <button onclick="tampilkanDetail('${safeId}', '${siswa.nama}', '${kelas}', '${mapel}', '${tglMulai}', '${tglSelesai}')" 
                                style="background:#3b82f6; color:white; border:none; padding:6px 12px; border-radius:6px; font-size:12px; cursor:pointer;">
                            <i class="fa-solid fa-eye"></i> Detail
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            // Update summary
            document.getElementById('totalHadir').textContent = totalHadir;
            document.getElementById('totalSakit').textContent = totalSakit;
            document.getElementById('totalIjin').textContent = totalIjin;
            document.getElementById('totalAlfa').textContent = totalAlfa;
            document.getElementById('summaryContainer').style.display = 'block';

            showStatus(`Data berhasil dimuat: ${siswaList.length} siswa`, 'success');

        } catch (error) {
            console.error(error);
            showStatus("Gagal memuat data: " + error.message, 'error');
        } finally {
            document.getElementById('loading').style.display = 'none';
        }
    }

    async function hitungAbsensiRange(kelas, startStr, endStr, mataPelajaran = 'semua') {
        const startDate = new Date(startStr);
        const endDate = new Date(endStr);
        const absensiRef = ref(db, 'absensi');
        const snapshot = await get(absensiRef);
        const rekap = {};

        if (snapshot.exists()) {
            const allDates = snapshot.val();
            Object.keys(allDates).forEach(tanggal => {
                if (tanggal === 'scanner_qr') return;
                const currentDate = new Date(tanggal);

                if (currentDate >= startDate && currentDate <= endDate) {
                    if (allDates[tanggal][kelas]) {
                        const dataKelas = allDates[tanggal][kelas];
                        Object.keys(dataKelas).forEach(siswaId => {
                            const dataAbsen = dataKelas[siswaId];
                            
                            // Filter berdasarkan mata pelajaran
                            const mp = dataAbsen.mata_pelajaran || 'akademik';
                            if (mataPelajaran === 'semua' || mp === mataPelajaran) {
                                if (!rekap[siswaId]) rekap[siswaId] = { h: 0, s: 0, i: 0, a: 0 };
                                const status = dataAbsen.status.toLowerCase();
                                if (status === 'hadir') rekap[siswaId].h++;
                                else if (status === 'sakit') rekap[siswaId].s++;
                                else if (status === 'ijin') rekap[siswaId].i++;
                                else if (status === 'alfa') rekap[siswaId].a++;
                            }
                        });
                    }
                }
            });
        }
        return rekap;
    }

    // Fungsi untuk menampilkan badge mata pelajaran
    function getMapelBadge(mapel) {
        if (mapel === 'semua') return '';
        
        const badgeClass = {
            'akademik': 'guru-akademik',
            'pjok': 'guru-pjok',
            'pai': 'guru-pai'
        }[mapel];
        
        const badgeText = {
            'akademik': 'Akademik',
            'pjok': 'PJOK',
            'pai': 'PAI'
        }[mapel];
        
        return `<span class="guru-badge ${badgeClass}">${badgeText}</span>`;
    }

    // Fungsi untuk menampilkan nama mata pelajaran
    function getMapelDisplayName(mapel) {
        const mapelNames = {
            'semua': 'Semua Mata Pelajaran',
            'akademik': 'Akademik (Guru Kelas)',
            'pjok': 'PJOK (Pendidikan Jasmani)',
            'pai': 'PAI (Pendidikan Agama Islam)'
        };
        return mapelNames[mapel] || mapel;
    }

    // Fungsi untuk menampilkan detail absensi per siswa
    async function tampilkanDetail(siswaId, namaSiswa, kelas, mapel, tglMulai, tglSelesai) {
        try {
            const startDate = new Date(tglMulai);
            const endDate = new Date(tglSelesai);
            const absensiRef = ref(db, 'absensi');
            const snapshot = await get(absensiRef);
            
            let detailHTML = `<h3 style="margin-top:0; color:#1e40af;">Detail Absensi</h3>`;
            detailHTML += `<p><strong>Nama:</strong> ${namaSiswa}</p>`;
            detailHTML += `<p><strong>Kelas:</strong> ${kelas}</p>`;
            detailHTML += `<p><strong>Mata Pelajaran:</strong> ${getMapelDisplayName(mapel)}</p>`;
            detailHTML += `<p><strong>Periode:</strong> ${tglMulai} s/d ${tglSelesai}</p>`;
            
            detailHTML += `<table style="width:100%; margin-top:15px; border-collapse:collapse;">`;
            detailHTML += `<thead><tr style="background:#f8fafc;">
                <th style="padding:10px; border-bottom:1px solid #ddd;">Tanggal</th>
                <th style="padding:10px; border-bottom:1px solid #ddd;">Status</th>
                <th style="padding:10px; border-bottom:1px solid #ddd;">Waktu</th>
                <th style="padding:10px; border-bottom:1px solid #ddd;">Mata Pelajaran</th>
                <th style="padding:10px; border-bottom:1px solid #ddd;">Metode</th>
                <th style="padding:10px; border-bottom:1px solid #ddd;">Guru</th>
            </tr></thead>`;
            detailHTML += `<tbody>`;
            
            if (snapshot.exists()) {
                const allDates = snapshot.val();
                let count = 0;
                
                Object.keys(allDates).forEach(tanggal => {
                    if (tanggal === 'scanner_qr') return;
                    const currentDate = new Date(tanggal);
                    
                    if (currentDate >= startDate && currentDate <= endDate) {
                        if (allDates[tanggal][kelas] && allDates[tanggal][kelas][siswaId]) {
                            const dataAbsen = allDates[tanggal][kelas][siswaId];
                            const mp = dataAbsen.mata_pelajaran || 'akademik';
                            
                            // Filter berdasarkan mata pelajaran
                            if (mapel === 'semua' || mp === mapel) {
                                const statusColor = {
                                    'hadir': '#10b981',
                                    'sakit': '#f59e0b',
                                    'ijin': '#3b82f6',
                                    'alfa': '#ef4444'
                                }[dataAbsen.status.toLowerCase()] || '#64748b';
                                
                                const mpColor = {
                                    'akademik': '#1e40af',
                                    'pjok': '#166534',
                                    'pai': '#92400e'
                                }[mp] || '#64748b';
                                
                                detailHTML += `<tr>
                                    <td style="padding:10px; border-bottom:1px solid #eee;">${tanggal}</td>
                                    <td style="padding:10px; border-bottom:1px solid #eee;">
                                        <span style="color:${statusColor}; font-weight:600;">${dataAbsen.status}</span>
                                    </td>
                                    <td style="padding:10px; border-bottom:1px solid #eee;">${dataAbsen.waktu || '-'}</td>
                                    <td style="padding:10px; border-bottom:1px solid #eee;">
                                        <span style="color:${mpColor}; font-weight:600;">${getMapelDisplayName(mp)}</span>
                                    </td>
                                    <td style="padding:10px; border-bottom:1px solid #eee;">${dataAbsen.metode || 'Manual'}</td>
                                    <td style="padding:10px; border-bottom:1px solid #eee;">${dataAbsen.pencatat || '-'}</td>
                                </tr>`;
                                count++;
                            }
                        }
                    }
                });
                
                if (count === 0) {
                    detailHTML += `<tr><td colspan="6" style="padding:20px; text-align:center; color:#94a3b8;">Tidak ada data absensi untuk periode ini.</td></tr>`;
                }
            }
            
            detailHTML += `</tbody></table>`;
            
            // Tampilkan modal
            showModal(detailHTML);
            
        } catch (error) {
            console.error("Error tampilkan detail:", error);
            alert("Gagal menampilkan detail: " + error.message);
        }
    }

    // Fungsi untuk menampilkan modal
    function showModal(content) {
        const modal = document.createElement('div');
        modal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        `;
        
        const modalContent = document.createElement('div');
        modalContent.style.cssText = `
            background: white;
            padding: 25px;
            border-radius: 12px;
            max-width: 900px;
            max-height: 80vh;
            overflow-y: auto;
            width: 90%;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        `;
        
        modalContent.innerHTML = content;
        
        const closeBtn = document.createElement('button');
        closeBtn.innerHTML = '<i class="fa-solid fa-times"></i> Tutup';
        closeBtn.style.cssText = `
            background: #64748b;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 15px;
            float: right;
        `;
        closeBtn.onclick = () => document.body.removeChild(modal);
        
        modalContent.appendChild(closeBtn);
        modal.appendChild(modalContent);
        document.body.appendChild(modal);
        
        // Close modal on outside click
        modal.onclick = (e) => {
            if (e.target === modal) {
                document.body.removeChild(modal);
            }
        };
    }

    // PERBAIKAN: Fungsi untuk menghapus data absensi dengan permission check
    async function hapusDataAbsensi() {
        const kelas = document.getElementById('pilihKelas').value;
        const mapel = document.getElementById('pilihMapel').value;
        const tglMulai = document.getElementById('tglMulai').value;
        const tglSelesai = document.getElementById('tglSelesai').value;

        if (!kelas || !tglMulai || !tglSelesai) {
            return alert("Pilih Kelas, Mata Pelajaran, dan Rentang Tanggal yang ingin dihapus!");
        }

        const mapelDisplay = getMapelDisplayName(mapel);
        
        if(!confirm(`PERINGATAN KERAS!\n\nAnda akan menghapus data absensi:\n• Kelas: ${kelas}\n• Mata Pelajaran: ${mapelDisplay}\n• Dari: ${tglMulai}\n• Sampai: ${tglSelesai}\n\nData yang dihapus TIDAK BISA DIKEMBALIKAN. Lanjutkan?`)) {
            return;
        }

        // Tampilkan loading dan progress bar
        document.getElementById('loading').style.display = 'block';
        document.getElementById('deleteProgress').style.display = 'block';
        document.getElementById('deleteProgressBar').style.width = '0%';
        document.getElementById('btnHapus').disabled = true;
        document.getElementById('btnHapus').innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Menghapus...';
        showStatus("Memulai proses penghapusan data...", 'warning');
        
        try {
            // 1. CHECK PERMISSION untuk database utama
            const hasPermission = await checkWritePermission(currentUserId, `absensi/${tglMulai}/${kelas}`);
            if (!hasPermission) {
                throw new Error("Anda tidak memiliki izin untuk menghapus data absensi. Pastikan login sebagai Admin.");
            }
            
            const startDate = new Date(tglMulai);
            const endDate = new Date(tglSelesai);
            
            // 2. Hapus dari database utama absensi (PERBAIKAN: Gunakan remove() untuk path yang benar)
            document.getElementById('deleteProgressBar').style.width = '25%';
            showStatus("Menghapus dari database utama...", 'warning');
            
            const deletedCount = await hapusAbsensiDariDatabaseSatuPerSatu(kelas, startDate, endDate, mapel);
            
            // 3. Update progress bar
            document.getElementById('deleteProgressBar').style.width = '50%';
            showStatus(`Berhasil menghapus ${deletedCount} data dari database utama`, 'success');
            
            // 4. Reset data absensi di nilai siswa (TANPA menghapus admin_rekap yang sudah ada)
            document.getElementById('deleteProgressBar').style.width = '75%';
            showStatus("Merreset data absensi di nilai siswa...", 'warning');
            
            await resetAbsensiDiNilaiSiswa(kelas, mapel, startDate, endDate);
            
            // 5. Update progress bar
            document.getElementById('deleteProgressBar').style.width = '100%';
            
            showStatus(`✅ Data Absensi berhasil dihapus! Total: ${deletedCount} data`, 'success');
            
            // Refresh tampilan
            setTimeout(() => {
                prosesRekap();
            }, 1500);
            
            // Reset form
            document.getElementById('confirmDelete').checked = false;
            document.getElementById('btnHapus').disabled = true;
            
        } catch (error) {
            console.error("Error hapus data:", error);
            showStatus(`❌ Gagal menghapus: ${error.message}`, 'error');
            alert("Gagal menghapus: " + error.message);
        } finally {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('deleteProgress').style.display = 'none';
            document.getElementById('btnHapus').innerHTML = '<i class="fa-solid fa-trash"></i> Hapus Data';
            document.getElementById('btnHapus').disabled = false;
        }
    }

    // Helper: Hapus absensi dari database utama SATU PER SATU (lebih aman untuk permission)
    async function hapusAbsensiDariDatabaseSatuPerSatu(kelas, startDate, endDate, mataPelajaran) {
        const absensiRef = ref(db, 'absensi');
        const snapshot = await get(absensiRef);
        let deletedCount = 0;
        const errors = [];

        if (snapshot.exists()) {
            const allDates = snapshot.val();
            
            // Loop setiap tanggal
            for (const tanggal of Object.keys(allDates)) {
                if (tanggal === 'scanner_qr') continue;
                
                const currentDate = new Date(tanggal);
                if (currentDate >= startDate && currentDate <= endDate) {
                    if (allDates[tanggal][kelas]) {
                        const dataKelas = allDates[tanggal][kelas];
                        
                        if (mataPelajaran === 'semua') {
                            // Hapus semua data untuk kelas ini di tanggal tersebut
                            try {
                                await remove(ref(db, `absensi/${tanggal}/${kelas}`));
                                deletedCount += Object.keys(dataKelas).length;
                                console.log(`✅ Hapus semua data untuk ${tanggal}/${kelas}`);
                            } catch (error) {
                                errors.push(`${tanggal}/${kelas}: ${error.message}`);
                            }
                        } else {
                            // Hapus hanya data dengan mata pelajaran tertentu
                            for (const siswaId of Object.keys(dataKelas)) {
                                const dataAbsen = dataKelas[siswaId];
                                const mp = dataAbsen.mata_pelajaran || 'akademik';
                                
                                if (mp === mataPelajaran) {
                                    try {
                                        await remove(ref(db, `absensi/${tanggal}/${kelas}/${siswaId}`));
                                        deletedCount++;
                                        console.log(`✅ Hapus data untuk ${tanggal}/${kelas}/${siswaId}`);
                                    } catch (error) {
                                        errors.push(`${tanggal}/${kelas}/${siswaId}: ${error.message}`);
                                    }
                                }
                            }
                        }
                    }
                }
            }
            
            // Tampilkan error jika ada
            if (errors.length > 0) {
                console.warn("Beberapa data gagal dihapus:", errors);
                if (errors.length > 3) {
                    showStatus(`⚠ ${deletedCount} data dihapus, ${errors.length} gagal`, 'warning');
                }
            }
        }
        
        return deletedCount;
    }

    // Helper: Reset absensi di nilai siswa (SET ke 0, bukan hapus)
    async function resetAbsensiDiNilaiSiswa(kelas, mataPelajaran, startDate, endDate) {
        try {
            // Tentukan semester berdasarkan bulan
            const startMonth = startDate.getMonth() + 1;
            const semester = (startMonth >= 1 && startMonth <= 6) ? 'genap' : 'ganjil';
            
            // Hanya reset untuk mapel tertentu, bukan semua
            if (mataPelajaran === 'semua') {
                const mapels = ['akademik', 'pjok', 'pai'];
                for (const mp of mapels) {
                    await resetAbsensiUntukMapel(kelas, mp, semester);
                }
            } else {
                await resetAbsensiUntukMapel(kelas, mataPelajaran, semester);
            }
            
        } catch (error) {
            console.error("Error reset absensi di nilai siswa:", error);
            throw error;
        }
    }

    // Helper: Reset absensi untuk mapel tertentu
    async function resetAbsensiUntukMapel(kelas, mapel, semester) {
        try {
            const nilaiRef = ref(db, `nilai/${mapel}/${kelas}`);
            const snapshot = await get(nilaiRef);
            
            if (!snapshot.exists()) return;
            
            const dataNilai = snapshot.val();
            const promises = [];
            
            // Loop semua siswa
            for (const siswaId of Object.keys(dataNilai)) {
                if (dataNilai[siswaId][semester]) {
                    // Hanya reset absensi, biarkan nilai lainnya tetap
                    const updateData = {
                        [`${semester}/sakit`]: 0,
                        [`${semester}/ijin`]: 0,
                        [`${semester}/alfa`]: 0,
                        [`${semester}/last_updated`]: new Date().toISOString(),
                        [`${semester}/updated_by`]: auth.currentUser?.email || 'admin'
                    };
                    
                    // Gunakan update() untuk mengubah hanya field absensi
                    promises.push(update(ref(db, `nilai/${mapel}/${kelas}/${siswaId}`), updateData));
                }
            }
            
            await Promise.all(promises);
            console.log(`✅ Reset absensi untuk ${mapel}/${kelas}/${semester}`);
            
        } catch (error) {
            console.error(`Error reset absensi untuk ${mapel}:`, error);
            throw error;
        }
    }

    function exportExcel() {
        const table = document.getElementById("rekapTable");
        const kelas = document.getElementById('pilihKelas').value;
        const mapel = document.getElementById('pilihMapel').value;
        
        if(!kelas) return alert("Tampilkan data dulu!");
        
        const mapelDisplay = getMapelDisplayName(mapel);
        const fileName = `Rekap_Absensi_${kelas}_${mapel}_${new Date().toISOString().split('T')[0]}.xlsx`;
        
        const wb = XLSX.utils.table_to_book(table, {sheet: "Laporan Absensi"});
        XLSX.writeFile(wb, fileName);
    }
</script>

</body>
</html>