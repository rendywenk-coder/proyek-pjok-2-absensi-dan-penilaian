<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generate QR Siswa - SDN Rawabuntu 03</title>
    <link rel="stylesheet" href="style_main.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            background-color: #f0f2f5;
            font-family: 'Poppins', sans-serif;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Card Styling */
        .header-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            margin-bottom: 30px;
            text-align: center;
        }

        .controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            align-items: center;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        select, button {
            padding: 12px 20px;
            border-radius: 8px;
            border: 1px solid #ddd;
            font-size: 16px;
        }

        button {
            background: var(--primary, #1e40af);
            color: white;
            border: none;
            cursor: pointer;
            transition: 0.3s;
        }

        button:hover {
            background: var(--primary-dark, #1e3a8a);
            transform: translateY(-2px);
        }

        /* Grid untuk Kartu QR */
        #qrContainer {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .student-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: 0.3s;
            border-top: 5px solid var(--secondary, #0ea5e9);
            position: relative;
        }

        .student-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.15);
        }

        .qr-image {
            width: 140px;
            height: 140px;
            margin-bottom: 10px;
            object-fit: contain;
        }

        .student-name {
            font-weight: 600;
            color: #333;
            font-size: 14px;
            margin-bottom: 5px;
            text-transform: uppercase;
        }

        .student-class {
            color: #666;
            font-size: 12px;
            background: #f3f4f6;
            padding: 2px 8px;
            border-radius: 4px;
            display: inline-block;
        }

        /* Loading State */
        .loading {
            text-align: center;
            width: 100%;
            padding: 40px;
            color: #666;
            display: none;
        }

        .print-btn {
            background: #10b981; /* Green */
        }

        @media print {
            .no-print { display: none !important; }
            .student-card { break-inside: avoid; border: 1px solid #ccc; box-shadow: none; }
            #qrContainer { display: block; }
            .student-card { display: inline-block; width: 45%; margin: 10px; }
        }
    </style>
</head>
<body>

    <div class="container">
        <div class="header-card no-print">
            <h2><i class="fa-solid fa-qrcode"></i> Generator QR Code Siswa</h2>
            <p>Pilih kelas untuk menampilkan dan mencetak kartu QR Absensi</p>
            
            <div class="controls">
                <select id="classSelect">
                     <option value="">-- Pilih Kelas --</option>
                        <option value="1A">Kelas 1A</option><option value="1B">Kelas 1B</option><option value="1C">Kelas 1C</option><option value="1D">Kelas 1D</option>
                        <option value="2A">Kelas 2A</option><option value="2B">Kelas 2B</option><option value="2C">Kelas 2C</option><option value="2D">Kelas 2D</option><option value="2E">Kelas 2E</option>
                        <option value="3A">Kelas 3A</option><option value="3B">Kelas 3B</option><option value="3C">Kelas 3C</option><option value="3D">Kelas 3D</option><option value="3E">Kelas 3E</option>
                        <option value="4A">Kelas 4A</option><option value="4B">Kelas 4B</option><option value="4C">Kelas 4C</option><option value="4D">Kelas 4D</option><option value="4E">Kelas 4E</option><option value="4F">Kelas 4F</option>
                        <option value="5A">Kelas 5A</option><option value="5B">Kelas 5B</option><option value="5C">Kelas 5C</option><option value="5D">Kelas 5D</option><option value="5E">Kelas 5E</option>
                        <option value="6A">Kelas 6A</option><option value="6B">Kelas 6B</option><option value="6C">Kelas 6C</option><option value="6D">Kelas 6D</option><option value="6E">Kelas 6E</option>

                </select>
                
                <button onclick="window.print()" class="print-btn">
                    <i class="fa-solid fa-print"></i> Cetak Halaman Ini
                </button>
                
                <button onclick="window.location.href='index.html'" style="background: #64748b;">
                    <i class="fa-solid fa-arrow-left"></i> Kembali
                </button>
            </div>
        </div>

        <div id="loading" class="loading">
            <i class="fa-solid fa-circle-notch fa-spin fa-2x"></i>
            <p>Memuat data siswa...</p>
        </div>

        <div id="qrContainer">
            <div style="grid-column: 1/-1; text-align: center; color: #888; padding: 50px;">
                <i class="fa-solid fa-arrow-up"></i><br>
                Silakan pilih kelas terlebih dahulu
            </div>
        </div>
    </div>

    <script type="module">
        // 1. Import fungsi yang dibutuhkan dari config
        import { db, ref, get, child } from './config_firebase.js';

        // 2. Referensi Elemen DOM
        const classSelect = document.getElementById('classSelect');
        const qrContainer = document.getElementById('qrContainer');
        const loadingDiv = document.getElementById('loading');

        // 3. Event Listener saat memilih kelas
        classSelect.addEventListener('change', async function() {
            const selectedClass = this.value;
            
            // Jika tidak memilih kelas (pilih opsi default)
            if (!selectedClass) {
                qrContainer.innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: #888; padding: 50px;">Silakan pilih kelas terlebih dahulu</div>';
                return;
            }

            // Tampilkan loading, sembunyikan container
            loadingDiv.style.display = 'block';
            qrContainer.innerHTML = '';

            try {
                // 4. Ambil data dari Firebase path: siswa/{KELAS}
                const dbRef = ref(db);
                // Mengambil snapshot data sekali saja
                const snapshot = await get(child(dbRef, `siswa/${selectedClass}`));

                if (snapshot.exists()) {
                    const data = snapshot.val();
                    renderStudents(data, selectedClass);
                } else {
                    qrContainer.innerHTML = `<div style="grid-column: 1/-1; text-align: center; color: #ef4444; padding: 20px;">Data siswa untuk kelas ${selectedClass} belum tersedia. Silakan upload data terlebih dahulu.</div>`;
                }

            } catch (error) {
                console.error("Error fetching data:", error);
                qrContainer.innerHTML = `<div style="grid-column: 1/-1; text-align: center; color: red;">Terjadi kesalahan: ${error.message}</div>`;
            } finally {
                // Sembunyikan loading
                loadingDiv.style.display = 'none';
            }
        });

        // 5. Fungsi Render Kartu Siswa
        function renderStudents(studentsData, className) {
            // Ubah object firebase menjadi array
            // Asumsi struktur: { "NAMA_SISWA": { nama: "...", ... } }
            const students = Object.values(studentsData);

            // Sortir berdasarkan nama agar rapi
            students.sort((a, b) => a.nama.localeCompare(b.nama));

            let htmlContent = '';

            students.forEach(student => {
                // Format data untuk QR: NAMA|KELAS
                const qrData = `${student.nama}|${className}`;
                
                // Gunakan API QR Server (Google Charts API sudah deprecated, pakai goqr.me atau qrserver)
                const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(qrData)}`;

                htmlContent += `
                    <div class="student-card">
                        <img src="${qrUrl}" alt="QR Code ${student.nama}" class="qr-image" loading="lazy">
                        <div class="student-name">${student.nama}</div>
                        <div class="student-class">${className}</div>
                    </div>
                `;
            });

            qrContainer.innerHTML = htmlContent;
        }
    </script>
</body>
</html>