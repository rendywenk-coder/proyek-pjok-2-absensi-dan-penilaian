<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <title>Penilaian Premium - SDN Rawabuntu 03</title>
    <link rel="stylesheet" href="style_main.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* === STYLE PREMIUM === */
        :root {
            --primary: #1e40af; 
            --secondary: #1e3a8a; 
            --accent: #f59e0b;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --info: #3b82f6;
        }
        
        body { 
            background: #f0f2f5; 
            font-family: 'Poppins', sans-serif; 
            margin: 0; 
            padding: 0;
            min-height: 100vh;
        }
        
        /* Navbar Premium */
        .navbar {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white; 
            padding: 15px 25px; 
            display: flex; 
            justify-content: space-between;
            align-items: center; 
            position: sticky; 
            top: 0; 
            z-index: 1000;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2); 
            border-bottom: 3px solid var(--accent);
        }
        
        .nav-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .nav-left i {
            font-size: 24px;
            background: rgba(255, 255, 255, 0.15);
            padding: 12px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .nav-center {
            flex: 1;
            text-align: center;
            font-weight: 600;
            font-size: 1.1rem;
        }
        
        .nav-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255,255,255,0.15);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
        }
        
        .btn-dashboard {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid rgba(255,255,255,0.3);
            padding: 8px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-dashboard:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.2);
        }
        
        /* Container Premium */
        .container-fluid { 
            padding: 25px; 
            max-width: 1400px; 
            margin: 0 auto; 
        }
        
        .card-premium {
            background: white; 
            border-radius: 16px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.05);
            padding: 25px; 
            margin-bottom: 25px; 
            border: 1px solid rgba(0,0,0,0.02);
            position: relative;
            overflow: hidden;
        }
        
        .card-premium::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--accent));
        }
        
        .filter-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
            gap: 15px; 
            margin-top: 15px; 
        }
        
        select, input { 
            width: 100%; 
            padding: 12px 15px; 
            border: 2px solid #cbd5e1; 
            border-radius: 8px; 
            font-size: 14px; 
            box-sizing: border-box; 
            font-family: 'Poppins', sans-serif;
            transition: all 0.3s ease;
        }
        
        select:focus, input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(30, 64, 175, 0.1);
        }
        
        button { 
            cursor: pointer; 
            transition: 0.3s; 
            font-weight: 600; 
            font-family: 'Poppins', sans-serif;
        }
        
        .btn-search { 
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white; 
            border: none; 
            padding: 14px; 
            border-radius: 8px; 
            width: 100%; 
            font-size: 15px;
            box-shadow: 0 4px 15px rgba(30, 64, 175, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .btn-search:hover { 
            background: linear-gradient(135deg, var(--secondary) 0%, #1e2f6e 100%);
            transform: translateY(-2px); 
            box-shadow: 0 6px 20px rgba(30, 64, 175, 0.4);
        }
        
        /* Tabel Premium */
        .table-container { 
            overflow-x: auto; 
            border-radius: 12px; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.05); 
            background: white;
            margin-top: 20px;
            position: relative;
        }
        
        table { 
            width: 100%; 
            border-collapse: collapse; 
            min-width: 1400px;
        }
        
        th { 
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            color: #334155; 
            padding: 15px 10px; 
            text-align: center; 
            border-bottom: 2px solid #e2e8f0; 
            font-size: 12px; 
            text-transform: uppercase; 
            letter-spacing: 0.5px; 
            font-weight: 600;
            white-space: nowrap;
        }
        
        td { 
            padding: 12px 8px; 
            border-bottom: 1px solid #f1f5f9; 
            text-align: center; 
            vertical-align: middle; 
            color: #475569; 
            font-size: 13px;
        }
        
        tr:hover { 
            background-color: #f8fafc; 
        }
        
        /* Input Nilai */
        .input-nilai {
            width: 60px;
            height: 40px;
            padding: 6px 4px;
            border: 2px solid #cbd5e1;
            border-radius: 6px;
            text-align: center;
            font-weight: 600;
            font-size: 13px;
            font-family: 'Poppins', monospace;
            transition: all 0.2s ease;
            background: white;
            color: #334155;
            margin: 2px;
        }
        
        .input-nilai:focus {
            border-color: var(--primary);
            outline: none;
            background: #eff6ff;
            transform: scale(1.05);
            box-shadow: 0 0 0 3px rgba(30, 64, 175, 0.1);
        }
        
        .input-nilai::-webkit-inner-spin-button,
        .input-nilai::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        
        .input-nilai[type="number"] {
            -moz-appearance: textfield;
        }
        
        /* Kolom Absensi Otomatis */
        .auto-filled {
            background-color: #f0f9ff;
            color: #0284c7;
            border-color: #bae6fd;
            cursor: default;
            font-weight: 700;
            font-size: 12px;
        }
        
        .auto-filled:focus {
            outline: none;
            border-color: #bae6fd;
            transform: none;
            box-shadow: none;
        }
        
        .badge-info { 
            background: #eff6ff; 
            color: #1d4ed8; 
            padding: 4px 8px; 
            border-radius: 12px; 
            font-size: 11px; 
            display: inline-block; 
            margin-top: 4px;
            font-weight: 500;
        }
        
        /* Kolom Nilai Akhir */
        .nilai-akhir-cell {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            font-weight: 700;
            border-left: 3px solid #0369a1;
            border-right: 3px solid #0369a1;
        }
        
        .grade-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 5px;
        }
        
        .grade-A { background: #dcfce7; color: #166534; }
        .grade-B { background: #dbeafe; color: #1e40af; }
        .grade-C { background: #fef3c7; color: #92400e; }
        .grade-D { background: #fee2e2; color: #991b1b; }
        .grade-E { background: #f3f4f6; color: #6b7280; }
        
        /* Loading Animation */
        #loading {
            display: none;
            text-align: center;
            padding: 40px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            margin: 20px 0;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #e2e8f0;
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Status Sync */
        #syncStatus {
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .status-success {
            color: #10b981;
        }
        
        .status-warning {
            color: #f59e0b;
        }
        
        .status-error {
            color: #ef4444;
        }
        
        /* Action Button */
        .btn-save {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            min-width: 80px;
            box-shadow: 0 4px 10px rgba(16, 185, 129, 0.3);
        }
        
        .btn-save:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(16, 185, 129, 0.4);
        }
        
        .btn-save:active {
            transform: translateY(0);
        }
        
        /* Info Box */
        .info-box {
            background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
            border-left: 4px solid #f59e0b;
            border-radius: 8px;
            padding: 12px 16px;
            margin-top: 15px;
            font-size: 12px;
            color: #92400e;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }
        
        /* System Info Box */
        .system-info {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border-left: 4px solid #0369a1;
            border-radius: 8px;
            padding: 12px 16px;
            margin-top: 15px;
            font-size: 12px;
            color: #0369a1;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }
        
        .formula-box {
            background: white;
            border: 1px solid #bae6fd;
            border-radius: 6px;
            padding: 8px 12px;
            margin-top: 8px;
            font-family: monospace;
            font-size: 11px;
            color: #0c4a6e;
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .container-fluid {
                padding: 15px;
            }
            
            .navbar {
                padding: 12px 15px;
                flex-direction: column;
                gap: 10px;
            }
            
            .nav-left, .nav-center, .nav-right {
                width: 100%;
                justify-content: center;
            }
            
            .nav-center {
                order: -1;
                margin-bottom: 10px;
            }
            
            .filter-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            
            .card-premium {
                padding: 20px;
            }
            
            th, td {
                padding: 10px 6px;
                font-size: 11px;
            }
            
            .input-nilai {
                width: 50px;
                height: 35px;
                font-size: 12px;
                padding: 4px 2px;
            }
            
            .btn-save {
                min-width: 70px;
                padding: 6px 12px;
                font-size: 11px;
            }
        }
        
        @media (max-width: 480px) {
            .container-fluid {
                padding: 10px;
            }
            
            .input-nilai {
                width: 45px;
                height: 32px;
                font-size: 11px;
            }
            
            .auto-filled {
                font-size: 11px;
            }
            
            th {
                font-size: 10px;
                padding: 8px 4px;
            }
            
            td {
                padding: 8px 4px;
                font-size: 10px;
            }
            
            .btn-save {
                min-width: 60px;
                padding: 5px 10px;
                font-size: 10px;
            }
        }
    </style>
</head>
<body>

    <nav class="navbar">
        <div class="nav-left">
            <i class="fa-solid fa-graduation-cap"></i>
            <span style="font-weight: 600;">E-Rapor & Absensi</span>
        </div>
        <div class="nav-center">
            SDN Rawabuntu 03 - Sistem Penilaian
        </div>
        <div class="nav-right">
            <div class="user-info">
                <i class="fa-solid fa-user-tie"></i>
                <span id="displayNamaGuru">Guru</span>
            </div>
            <button onclick="window.location.href='index.html'" class="btn-dashboard">
                <i class="fa-solid fa-home"></i> Dashboard
            </button>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="card-premium">
            <h3 style="color: var(--primary); margin:0 0 15px 0; border-bottom: 2px solid #f1f5f9; padding-bottom: 10px; display:flex; justify-content:space-between; align-items:center;">
                <span><i class="fa-solid fa-filter"></i> Filter Penilaian</span>
                <span id="syncStatus" style="font-weight:normal;">
                    <i class="fa-solid fa-clock"></i> Menunggu input...
                </span>
            </h3>
            
            <div class="filter-grid">
                <div>
                    <label style="font-size: 12px; font-weight: 600; color: #64748b;">Mata Pelajaran</label>
                    <select id="pilihMapel">
                        <option value="akademik">Akademik (Guru Kelas)</option>
                        <option value="pjok">PJOK (Penjas)</option>
                        <option value="pai">PAI (Agama)</option>
                    </select>
                </div>
                <div>
                    <label style="font-size: 12px; font-weight: 600; color: #64748b;">Kelas</label>
                    <select id="pilihKelas">
                        <option value="">-- Pilih Kelas --</option>
                        <option value="1A">Kelas 1A</option>
                        <option value="1B">Kelas 1B</option>
                        <option value="1C">Kelas 1C</option>
                        <option value="1D">Kelas 1D</option>
                        <option value="2A">Kelas 2A</option>
                        <option value="2B">Kelas 2B</option>
                        <option value="2C">Kelas 2C</option>
                        <option value="2D">Kelas 2D</option>
                        <option value="2E">Kelas 2E</option>
                        <option value="3A">Kelas 3A</option>
                        <option value="3B">Kelas 3B</option>
                        <option value="3C">Kelas 3C</option>
                        <option value="3D">Kelas 3D</option>
                        <option value="3E">Kelas 3E</option>
                        <option value="4A">Kelas 4A</option>
                        <option value="4B">Kelas 4B</option>
                        <option value="4C">Kelas 4C</option>
                        <option value="4D">Kelas 4D</option>
                        <option value="4E">Kelas 4E</option>
                        <option value="4F">Kelas 4F</option>
                        <option value="5A">Kelas 5A</option>
                        <option value="5B">Kelas 5B</option>
                        <option value="5C">Kelas 5C</option>
                        <option value="5D">Kelas 5D</option>
                        <option value="5E">Kelas 5E</option>
                        <option value="6A">Kelas 6A</option>
                        <option value="6B">Kelas 6B</option>
                        <option value="6C">Kelas 6C</option>
                        <option value="6D">Kelas 6D</option>
                        <option value="6E">Kelas 6E</option>
                    </select>
                </div>
                <div>
                    <label style="font-size: 12px; font-weight: 600; color: #64748b;">Semester</label>
                    <select id="pilihSemester">
                        <option value="ganjil">Semester Ganjil (Juli - Des)</option>
                        <option value="genap">Semester Genap (Jan - Jun)</option>
                    </select>
                </div>
                <div style="display: flex; align-items: flex-end;">
                    <button onclick="loadDataSiswa()" class="btn-search">
                        <i class="fa-solid fa-magnifying-glass"></i> Tampilkan Data
                    </button>
                </div>
            </div>
            
            <div class="system-info">
                <i class="fa-solid fa-calculator"></i>
                <div>
                    <strong>Sistem Penilaian Otomatis:</strong>
                    <div class="formula-box">
                        Nilai Akhir = (65% Rata-rata N1-N4) + (35% STS/SAS) - Penalti Kehadiran<br>
                        Penalti: Alfa = 0.5/alfa (maks 5%) | Ijin/Sakit >10 = 2%
                    </div>
                </div>
            </div>
        </div>

        <div id="loading" style="display: none;">
            <div class="loading-spinner"></div>
            <p style="margin-top: 15px; color: #64748b; font-weight: 500;">
                Sedang menghitung nilai akhir...
            </p>
            <p style="color: #94a3b8; font-size: 12px; margin-top: 5px;">
                Sistem sedang memproses perhitungan sesuai blueprint penilaian
            </p>
        </div>

        <div class="table-container">
            <table id="tabelNilai">
                <thead>
                    <tr>
                        <th rowspan="2" style="width: 40px;">No</th>
                        <th rowspan="2" style="text-align: left; min-width: 200px; padding-left: 15px;">Nama Siswa</th>
                        <th colspan="5" style="background: #eff6ff; color: var(--primary);">Nilai Pengetahuan</th>
                        <th colspan="3" style="background: #fff7ed; color: #ea580c;">Kehadiran (Otomatis)</th>
                        <th colspan="3" style="background: #f0f9ff; color: #0369a1;">Nilai Akhir (Otomatis)</th>
                        <th rowspan="2" style="width: 90px;">Simpan</th>
                    </tr>
                    <tr>
                        <!-- Nilai Pengetahuan -->
                        <th style="background: #eff6ff; font-size: 11px;">N1</th>
                        <th style="background: #eff6ff; font-size: 11px;">N2</th>
                        <th style="background: #eff6ff; font-size: 11px;">N3</th>
                        <th style="background: #eff6ff; font-size: 11px;">N4</th>
                        <th style="background: #eff6ff; font-size: 11px;">
                            <span id="stsLabel">STS</span>
                        </th>
                        
                        <!-- Kehadiran -->
                        <th style="background: #fff7ed; color: #d97706; font-size: 11px;">S</th>
                        <th style="background: #fff7ed; color: #2563eb; font-size: 11px;">I</th>
                        <th style="background: #fff7ed; color: #dc2626; font-size: 11px;">A</th>
                        
                        <!-- Nilai Akhir -->
                        <th style="background: #f0f9ff; color: #0369a1; font-size: 11px;">Nilai</th>
                        <th style="background: #f0f9ff; color: #0369a1; font-size: 11px;">Huruf</th>
                        <th style="background: #f0f9ff; color: #0369a1; font-size: 11px;">Keterangan</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <tr>
                        <td colspan="14" style="padding: 40px; color: #94a3b8; text-align: center;">
                            <i class="fa-solid fa-table" style="font-size: 48px; opacity: 0.5; margin-bottom: 15px; display: block;"></i>
                            <p style="font-weight: 500; margin: 0;">Silakan pilih Kelas dan Semester</p>
                            <p style="font-size: 14px; color: #64748b; margin-top: 5px;">Klik "Tampilkan Data" untuk memulai</p>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script type="module">
        import { 
            db, auth, onAuthStateChanged, ref, get, update, 
            syncNilaiToAdmin, getUserData, hitungRekapAbsensi,
            hitungNilaiAkhir  // Import fungsi hitung nilai akhir REVISI
        } from './config_firebase.js';

        // 1. Auto Set Semester berdasarkan Bulan Ini
        const today = new Date();
        const curMonth = today.getMonth() + 1;
        const semesterSelect = document.getElementById('pilihSemester');
        
        if (curMonth >= 1 && curMonth <= 6) {
            semesterSelect.value = 'genap';
        } else {
            semesterSelect.value = 'ganjil';
        }

        // 2. Update label STS/SAS berdasarkan semester
        function updateStsLabel() {
            const semester = semesterSelect.value;
            const stsLabel = document.getElementById('stsLabel');
            if (semester === 'ganjil') {
                stsLabel.textContent = 'STS';
                stsLabel.title = 'Sumatif Tengah Semester (Semester Ganjil)';
            } else {
                stsLabel.textContent = 'SAS';
                stsLabel.title = 'Sumatif Akhir Semester (Semester Genap)';
            }
        }
        
        semesterSelect.addEventListener('change', updateStsLabel);
        updateStsLabel(); // Initial call

        // 3. Cek Login & Ambil Data User
        let currentUserRole = null;
        let currentUserMapel = null;
        let currentUserEmail = null;
        
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUserEmail = user.email;
                const displayName = user.displayName || user.email || 'Guru';
                document.getElementById('displayNamaGuru').textContent = displayName.split('@')[0];
                
                try {
                    const userData = await getUserData(user.uid);
                    if (userData) {
                        currentUserRole = userData.role;
                        
                        const mapelSelect = document.getElementById('pilihMapel');
                        
                        if (currentUserRole.includes('PJOK')) {
                            mapelSelect.value = 'pjok';
                            currentUserMapel = 'pjok';
                        } else if (currentUserRole.includes('PAI')) {
                            mapelSelect.value = 'pai';
                            currentUserMapel = 'pai';
                        } else {
                            mapelSelect.value = 'akademik';
                            currentUserMapel = 'akademik';
                        }
                        
                        if (currentUserRole !== 'ADMIN') {
                            mapelSelect.disabled = true;
                            mapelSelect.title = "Mata pelajaran ditentukan berdasarkan role Anda";
                        }
                    }
                } catch (error) {
                    console.error("Error getting user data:", error);
                }
            } else {
                window.location.href = 'index.html';
            }
        });

        // 4. Global Functions
        window.loadDataSiswa = loadDataSiswa;
        window.simpanNilai = simpanNilai;
        window.hitungNilaiOtomatis = hitungNilaiOtomatis;

        // 5. Fungsi untuk hitung nilai otomatis saat input berubah
        function hitungNilaiOtomatis(safeId) {
            const mapel = document.getElementById('pilihMapel').value;
            const semester = document.getElementById('pilihSemester').value;
            
            // Ambil nilai dari input
            const s1 = parseInt(document.getElementById(`s1-${safeId}`).value) || 0;
            const s2 = parseInt(document.getElementById(`s2-${safeId}`).value) || 0;
            const s3 = parseInt(document.getElementById(`s3-${safeId}`).value) || 0;
            const s4 = parseInt(document.getElementById(`s4-${safeId}`).value) || 0;
            const sts = parseInt(document.getElementById(`sts-${safeId}`).value) || 0;
            const sakit = parseInt(document.getElementById(`sakit-${safeId}`).value) || 0;
            const ijin = parseInt(document.getElementById(`ijin-${safeId}`).value) || 0;
            const alfa = parseInt(document.getElementById(`alfa-${safeId}`).value) || 0;
            
            // Hitung nilai akhir menggunakan fungsi dari config_firebase
            const hasil = hitungNilaiAkhir(s1, s2, s3, s4, sts, sakit, ijin, alfa, semester);
            
            // Update tampilan nilai akhir
            document.getElementById(`nilai-akhir-${safeId}`).textContent = hasil.nilai.toFixed(2);
            document.getElementById(`huruf-${safeId}`).innerHTML = `<span class="grade-badge grade-${hasil.huruf}">${hasil.huruf}</span>`;
            document.getElementById(`keterangan-${safeId}`).textContent = hasil.keterangan;
            
            // Update warna berdasarkan nilai
            const nilaiCell = document.getElementById(`nilai-akhir-${safeId}`).parentElement;
            nilaiCell.style.color = getColorFromGrade(hasil.huruf);
            
            return hasil;
        }

        // 6. Helper function untuk warna berdasarkan grade
        function getColorFromGrade(grade) {
            const colors = {
                'A': '#166534',
                'B': '#1e40af',
                'C': '#92400e',
                'D': '#991b1b',
                'E': '#6b7280'
            };
            return colors[grade] || '#6b7280';
        }

        // 7. Validasi Input Nilai
        function validateNilaiInput(input) {
            const value = parseInt(input.value);
            if (isNaN(value)) {
                input.value = '';
                return;
            }
            
            if (value < 0) {
                input.value = 0;
            } else if (value > 100) {
                input.value = 100;
            }
            
            if (value >= 0 && value <= 9) {
                input.value = '0' + value;
            }
            
            // Trigger hitung nilai otomatis jika input berubah
            const idParts = input.id.split('-');
            if (idParts.length >= 2) {
                const safeId = idParts.slice(1).join('-').replace(/s1-|s2-|s3-|s4-|sts-/g, '');
                if (safeId) {
                    hitungNilaiOtomatis(safeId);
                }
            }
        }

        // 8. Main Function to Load Data
        async function loadDataSiswa() {
            const mapel = document.getElementById('pilihMapel').value;
            const kelas = document.getElementById('pilihKelas').value;
            const semester = document.getElementById('pilihSemester').value;
            const statusEl = document.getElementById('syncStatus');

            if (!kelas) {
                alert("Harap pilih kelas terlebih dahulu!");
                return;
            }

            if (currentUserRole !== 'ADMIN') {
                if (currentUserMapel && mapel !== currentUserMapel) {
                    alert(`Anda tidak memiliki akses ke mata pelajaran ini. Akses Anda: ${currentUserMapel}`);
                    document.getElementById('pilihMapel').value = currentUserMapel;
                    return;
                }
            }

            document.getElementById('loading').style.display = 'block';
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            statusEl.innerHTML = '<i class="fa-solid fa-sync fa-spin"></i> Memuat data...';
            statusEl.className = 'status-warning';

            try {
                const siswaSnap = await get(ref(db, `siswa/${kelas}`));
                if (!siswaSnap.exists()) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="14" style="padding: 40px; text-align: center; color: #94a3b8;">
                                <i class="fa-solid fa-users-slash" style="font-size: 48px; margin-bottom: 15px; opacity: 0.5;"></i>
                                <p style="font-weight: 500;">Data siswa tidak ditemukan untuk kelas ${kelas}</p>
                            </td>
                        </tr>
                    `;
                    document.getElementById('loading').style.display = 'none';
                    statusEl.innerHTML = '<i class="fa-solid fa-triangle-exclamation"></i> Data siswa kosong';
                    statusEl.className = 'status-error';
                    return;
                }

                const nilaiSnap = await get(ref(db, `nilai/${mapel}/${kelas}`));
                const dataNilai = nilaiSnap.exists() ? nilaiSnap.val() : {};

                const rekapAbsen = await hitungRekapAbsensi(kelas, semester, mapel);
                statusEl.innerHTML = `<i class="fa-solid fa-check-circle"></i> Data absensi ${semester} tersinkron`;
                statusEl.className = 'status-success';

                const siswaList = Object.values(siswaSnap.val()).sort((a,b) => a.nama.localeCompare(b.nama));
                let no = 1;

                siswaList.forEach(siswa => {
                    const safeId = siswa.nama.replace(/[.#$/[\]]/g, '_');
                    
                    const n = (dataNilai[safeId] && dataNilai[safeId][semester]) ? dataNilai[safeId][semester] : {};
                    const abs = rekapAbsen[safeId] || { s: 0, i: 0, a: 0 };
                    
                    // Hitung nilai awal
                    const s1 = n.s1 || 0;
                    const s2 = n.s2 || 0;
                    const s3 = n.s3 || 0;
                    const s4 = n.s4 || 0;
                    const sts = n.sts || 0;
                    const sakit = abs.s || 0;
                    const ijin = abs.i || 0;
                    const alfa = abs.a || 0;
                    
                    const hasilNilaiAkhir = hitungNilaiAkhir(s1, s2, s3, s4, sts, sakit, ijin, alfa, semester);

                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${no++}</td>
                        <td style="text-align: left; padding-left: 15px;">
                            <div style="font-weight: 600; color:#334155; margin-bottom: 3px; font-size: 13px;">${siswa.nama}</div>
                            ${(abs.s > 0 || abs.i > 0 || abs.a > 0) ? 
                                '<span class="badge-info"><i class="fa-solid fa-check-circle"></i> Data absen tersedia</span>' : 
                                '<span class="badge-info" style="background: #f1f5f9; color: #64748b;"><i class="fa-solid fa-clock"></i> Menunggu absen</span>'}
                        </td>
                        
                        <!-- Nilai Pengetahuan -->
                        <td>
                            <input type="number" min="0" max="100" class="input-nilai" 
                                   id="s1-${safeId}" value="${n.s1 || ''}" 
                                   placeholder="0-100" 
                                   onchange="validateNilaiInput(this)"
                                   oninput="validateNilaiInput(this)">
                        </td>
                        <td>
                            <input type="number" min="0" max="100" class="input-nilai" 
                                   id="s2-${safeId}" value="${n.s2 || ''}" 
                                   placeholder="0-100"
                                   onchange="validateNilaiInput(this)"
                                   oninput="validateNilaiInput(this)">
                        </td>
                        <td>
                            <input type="number" min="0" max="100" class="input-nilai" 
                                   id="s3-${safeId}" value="${n.s3 || ''}" 
                                   placeholder="0-100"
                                   onchange="validateNilaiInput(this)"
                                   oninput="validateNilaiInput(this)">
                        </td>
                        <td>
                            <input type="number" min="0" max="100" class="input-nilai" 
                                   id="s4-${safeId}" value="${n.s4 || ''}" 
                                   placeholder="0-100"
                                   onchange="validateNilaiInput(this)"
                                   oninput="validateNilaiInput(this)">
                        </td>
                        <td>
                            <input type="number" min="0" max="100" class="input-nilai" 
                                   id="sts-${safeId}" value="${n.sts || ''}" 
                                   placeholder="0-100" 
                                   style="background:#f8fafc;"
                                   onchange="validateNilaiInput(this)"
                                   oninput="validateNilaiInput(this)">
                        </td>
                        
                        <!-- Kehadiran Otomatis -->
                        <td><input type="number" class="input-nilai auto-filled" id="sakit-${safeId}" value="${abs.s}" readonly></td>
                        <td><input type="number" class="input-nilai auto-filled" id="ijin-${safeId}" value="${abs.i}" readonly></td>
                        <td><input type="number" class="input-nilai auto-filled" id="alfa-${safeId}" value="${abs.a}" readonly></td>
                        
                        <!-- Nilai Akhir Otomatis -->
                        <td class="nilai-akhir-cell" id="nilai-akhir-${safeId}" style="font-weight: 700; font-size: 15px; color: ${getColorFromGrade(hasilNilaiAkhir.huruf)};">
                            ${hasilNilaiAkhir.nilai.toFixed(2)}
                        </td>
                        <td class="nilai-akhir-cell" id="huruf-${safeId}">
                            <span class="grade-badge grade-${hasilNilaiAkhir.huruf}">${hasilNilaiAkhir.huruf}</span>
                        </td>
                        <td class="nilai-akhir-cell" id="keterangan-${safeId}" style="font-size: 12px; color: #64748b;">
                            ${hasilNilaiAkhir.keterangan}
                        </td>
                        
                        <!-- Tombol Simpan -->
                        <td>
                            <button onclick="simpanNilai('${safeId}')" class="btn-save" title="Simpan nilai untuk ${siswa.nama}">
                                <i class="fa-solid fa-floppy-disk"></i> Simpan
                            </button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });

            } catch (error) {
                console.error('Error loading data:', error);
                statusEl.innerHTML = `<i class="fa-solid fa-triangle-exclamation"></i> Error: ${error.message}`;
                statusEl.className = 'status-error';
                alert("Terjadi kesalahan: " + error.message);
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        // 9. Function to Save Score - DENGAN SINKRONISASI OTOMATIS (FIXED)
        async function simpanNilai(siswaId) {
            const mapel = document.getElementById('pilihMapel').value;
            const kelas = document.getElementById('pilihKelas').value;
            const semester = document.getElementById('pilihSemester').value;
            
            // Fix: Get statusEl di awal fungsi
            const statusEl = document.getElementById('syncStatus');

            const inputs = ['s1', 's2', 's3', 's4', 'sts'];
            for (const input of inputs) {
                const value = document.getElementById(`${input}-${siswaId}`).value;
                if (value && (parseInt(value) < 0 || parseInt(value) > 100)) {
                    alert(`Nilai ${input} harus antara 0-100`);
                    document.getElementById(`${input}-${siswaId}`).focus();
                    return;
                }
            }

            let namaSiswa = '';
            try {
                const siswaSnap = await get(ref(db, `siswa/${kelas}`));
                if (siswaSnap.exists()) {
                    const siswaList = Object.values(siswaSnap.val());
                    const siswa = siswaList.find(s => s.nama.replace(/[.#$/[\]]/g, '_') === siswaId);
                    if (siswa) {
                        namaSiswa = siswa.nama;
                    }
                }
            } catch (error) {
                console.error("Error getting student name:", error);
            }

            const dataToSave = {
                s1: document.getElementById(`s1-${siswaId}`).value ? parseInt(document.getElementById(`s1-${siswaId}`).value) : null,
                s2: document.getElementById(`s2-${siswaId}`).value ? parseInt(document.getElementById(`s2-${siswaId}`).value) : null,
                s3: document.getElementById(`s3-${siswaId}`).value ? parseInt(document.getElementById(`s3-${siswaId}`).value) : null,
                s4: document.getElementById(`s4-${siswaId}`).value ? parseInt(document.getElementById(`s4-${siswaId}`).value) : null,
                sts: document.getElementById(`sts-${siswaId}`).value ? parseInt(document.getElementById(`sts-${siswaId}`).value) : null,
                
                sakit: parseInt(document.getElementById(`sakit-${siswaId}`).value) || 0,
                ijin: parseInt(document.getElementById(`ijin-${siswaId}`).value) || 0,
                alfa: parseInt(document.getElementById(`alfa-${siswaId}`).value) || 0,
                
                nama_siswa: namaSiswa,
                kelas: kelas,
                mata_pelajaran: mapel,
                semester: semester,
                guru_pencatat: currentUserEmail || 'unknown',
                last_updated: new Date().toISOString(),
                updated_by: currentUserEmail || 'unknown'
            };

            const targetRef = ref(db, `nilai/${mapel}/${kelas}/${siswaId}/${semester}`);
            
            try {
                await update(targetRef, dataToSave);
                
                // SINKRONISASI KE ADMIN - menggunakan fungsi dari config_firebase
                const syncResult = await syncNilaiToAdmin(dataToSave, siswaId, mapel, kelas, semester);
                
                const btn = document.querySelector(`button[onclick="simpanNilai('${siswaId}')"]`);
                const originalHTML = btn.innerHTML;
                
                if (syncResult.success) {
                    btn.innerHTML = '<i class="fa-solid fa-check"></i> Tersinkron!';
                    statusEl.innerHTML = `<i class="fa-solid fa-check-circle"></i> Data tersimpan & tersinkron`;
                    statusEl.className = 'status-success';
                } else {
                    btn.innerHTML = '<i class="fa-solid fa-floppy-disk"></i> Tersimpan!';
                    statusEl.innerHTML = `<i class="fa-solid fa-check-circle"></i> Data tersimpan (sinkron gagal)`;
                    statusEl.className = 'status-warning';
                }
                
                btn.style.background = 'linear-gradient(135deg, #059669 0%, #047857 100%)';
                btn.disabled = true;
                
                setTimeout(() => {
                    btn.innerHTML = originalHTML;
                    btn.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
                    btn.disabled = false;
                }, 2000);
                
            } catch (error) {
                alert("Gagal menyimpan data: " + error.message);
                statusEl.innerHTML = `<i class="fa-solid fa-triangle-exclamation"></i> Gagal menyimpan`;
                statusEl.className = 'status-error';
            }
        }
    </script>
</body>
</html>