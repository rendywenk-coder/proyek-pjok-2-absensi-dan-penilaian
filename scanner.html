
<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scanner Absensi - SDN Rawabuntu 03</title>
    <link rel="stylesheet" href="style_main.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        body { 
            background-color: #f0f2f5; 
            font-family: 'Poppins', sans-serif; 
            margin: 0;
            padding: 0;
        }
        .scanner-container {
            max-width: 600px; 
            margin: 20px auto; 
            background: white;
            padding: 20px; 
            border-radius: 15px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            position: relative;
        }
        #reader { 
            width: 100%; 
            border-radius: 10px; 
            overflow: hidden; 
            background: #000; 
            position: relative;
        }
        .result-box {
            margin-top: 20px; 
            padding: 15px; 
            border-radius: 10px;
            display: none; 
            text-align: center;
            transition: all 0.3s ease;
        }
        .success { 
            background-color: #d1fae5; 
            color: #065f46; 
            border: 1px solid #34d399; 
        }
        .error { 
            background-color: #fee2e2; 
            color: #991b1b; 
            border: 1px solid #f87171; 
        }
        .btn-back {
            display: inline-block; 
            margin-top: 20px; 
            text-decoration: none;
            color: #64748b; 
            font-weight: 500;
            padding: 10px 20px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        .btn-back:hover {
            background-color: #f1f5f9;
            color: #334155;
        }
        
        /* Info box untuk mata pelajaran */
        .info-box {
            background: #eff6ff;
            border-radius: 10px;
            padding: 12px 15px;
            margin-bottom: 15px;
            border-left: 4px solid #3b82f6;
            animation: fadeIn 0.5s ease;
        }
        
        .info-box h4 {
            margin: 0 0 5px 0;
            color: #1e40af;
            font-size: 14px;
        }
        
        .info-box p {
            margin: 0;
            color: #475569;
            font-size: 13px;
        }
        
        /* Loading overlay */
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            color: white;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }
        
        .scan-counter {
            background: #3b82f6;
            color: white;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            margin-top: 10px;
            display: inline-block;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Camera selector */
        .camera-selector {
            margin: 15px 0;
            padding: 10px;
            border-radius: 8px;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
        }
        
        .camera-selector select {
            width: 100%;
            padding: 8px;
            border-radius: 6px;
            border: 1px solid #cbd5e1;
            background: white;
            font-family: 'Poppins', sans-serif;
        }
        
        /* Debug info (bisa di-hide) */
        .debug-info {
            font-size: 11px;
            color: #64748b;
            margin-top: 10px;
            padding: 8px;
            background: #f1f5f9;
            border-radius: 6px;
            display: none; /* Sembunyikan di production */
        }
    </style>
</head>
<body>

<!-- Loading Overlay -->
<div id="loadingOverlay" class="loading-overlay">
    <div class="loading-spinner"></div>
    <p>Memproses absensi...</p>
</div>

<div class="scanner-container">
    <h3 style="text-align: center; color: #1e40af;">
        <i class="fa-solid fa-qrcode"></i> Scan Absensi
        <span id="scanCounter" class="scan-counter">0</span>
    </h3>
    
    <!-- Camera Selection -->
    <div class="camera-selector" id="cameraSelector" style="display: none;">
        <label for="cameraSelect"><i class="fa-solid fa-camera"></i> Pilih Kamera:</label>
        <select id="cameraSelect"></select>
    </div>
    
    <div class="info-box">
        <h4><i class="fa-solid fa-info-circle"></i> Informasi Guru</h4>
        <p id="guruInfo">Sedang memuat informasi...</p>
    </div>
    
    <p style="text-align: center; color: #64748b; font-size: 14px;">
        Arahkan kamera ke Kartu QR Siswa
        <br>
        <small style="color: #94a3b8;">Scanner otomatis mendeteksi QR berulang</small>
    </p>

    <div id="reader"></div>

    <div id="resultBox" class="result-box">
        <h4 id="resultTitle" style="margin:0;"></h4>
        <p id="resultMessage" style="margin:5px 0 0;"></p>
        <div id="resultDetails" style="font-size:12px; margin-top:8px; color:#475569;"></div>
    </div>
    
    <!-- Manual Input Fallback -->
    <div style="margin-top: 20px; padding: 15px; background: #f8fafc; border-radius: 10px; display: none;" id="manualInputSection">
        <h5 style="margin:0 0 10px 0; color: #475569;">
            <i class="fa-solid fa-keyboard"></i> Input Manual (Fallback)
        </h5>
        <input type="text" id="manualInput" placeholder="Masukkan NAMA|KELAS (contoh: AHMAD|1A)" 
               style="width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; margin-bottom: 10px;">
        <button id="manualSubmit" style="width: 100%; padding: 10px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer;">
            Simpan Absensi Manual
        </button>
    </div>

    <!-- Debug Info -->
    <div class="debug-info" id="debugInfo">
        Status: <span id="debugStatus">Idle</span> | 
        Queue: <span id="debugQueue">0</span> | 
        Last Scan: <span id="debugLastScan">-</span>
    </div>

    <div style="text-align: center;">
        <a href="index.html" class="btn-back">
            <i class="fa-solid fa-arrow-left"></i> Kembali ke Dashboard
        </a>
    </div>
</div>

<audio id="beepSuccess" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" preload="auto"></audio>
<audio id="beepError" src="https://assets.mixkit.co/active_storage/sfx/2572/2572-preview.mp3" preload="auto"></audio>

<script type="module">
    import { db, ref, set, get, auth, onAuthStateChanged, child, getUserData } from './config_firebase.js';

    // ========== VARIABEL GLOBAL YANG DIPERBAIKI ==========
    let html5QrcodeScanner = null;
    let currentUser = null;
    let currentUserRole = null;
    let currentUserMapel = null;
    
    // FLAG & QUEUE SYSTEM YANG LEBIH AMAN
    let isProcessing = false;
    let scanQueue = [];
    let processedScans = new Set(); // Untuk mencegah duplikasi dalam waktu singkat
    let scanCount = 0;
    let lastScanTime = 0;
    const SCAN_COOLDOWN = 1000; // 1 detik cooldown antara scan
    
    // ========== FUNGSI HELPER YANG DIPERBAIKI ==========
    
    // 1. Update debug info
    function updateDebugInfo() {
        document.getElementById('debugStatus').textContent = isProcessing ? 'Processing' : 'Ready';
        document.getElementById('debugQueue').textContent = scanQueue.length;
        document.getElementById('debugLastScan').textContent = 
            lastScanTime ? new Date(lastScanTime).toLocaleTimeString() : '-';
    }
    
    // 2. Tampilkan loading
    function showLoading(show) {
        const overlay = document.getElementById('loadingOverlay');
        if (show) {
            overlay.style.display = 'flex';
        } else {
            setTimeout(() => {
                overlay.style.display = 'none';
            }, 300);
        }
    }
    
    // 3. Membersihkan Key Database (TETAP SAMA)
    function sanitizeKey(text) {
        return text.replace(/[.#$/[\]]/g, '_');
    }
    
    // 4. Generate scan ID unik untuk mencegah duplikasi
    function generateScanId(namaSiswa, kelasSiswa) {
        const timestamp = Math.floor(Date.now() / 10000); // Dibulatkan per 10 detik
        return `${sanitizeKey(namaSiswa)}_${kelasSiswa}_${timestamp}`;
    }
    
    // 5. Cek apakah scan sudah diproses baru-baru ini
    function isRecentlyProcessed(scanId) {
        return processedScans.has(scanId);
    }
    
    // 6. Tambahkan ke processed scans dengan auto-cleanup
    function addToProcessed(scanId) {
        processedScans.add(scanId);
        
        // Auto cleanup setelah 5 menit
        setTimeout(() => {
            processedScans.delete(scanId);
        }, 5 * 60 * 1000);
    }
    
    // 7. Validasi format QR
    function validateQRFormat(decodedText) {
        const parts = decodedText.split('|');
        if (parts.length < 2) {
            return { valid: false, error: "Format QR tidak valid. Harus: NAMA|KELAS" };
        }
        
        const namaSiswa = parts[0].trim();
        const kelasSiswa = parts[1].trim();
        
        if (!namaSiswa || namaSiswa.length < 2) {
            return { valid: false, error: "Nama siswa terlalu pendek" };
        }
        
        if (!kelasSiswa || kelasSiswa.length < 2) {
            return { valid: false, error: "Format kelas tidak valid" };
        }
        
        return { 
            valid: true, 
            namaSiswa, 
            kelasSiswa,
            rawText: decodedText
        };
    }
    
    // 8. Tampilkan hasil dengan animasi
    function showResult(isSuccess, title, message, details = '') {
        const box = document.getElementById('resultBox');
        const titleEl = document.getElementById('resultTitle');
        const msgEl = document.getElementById('resultMessage');
        const detailsEl = document.getElementById('resultDetails');
        
        // Reset animasi
        box.style.animation = 'none';
        box.offsetHeight; // Trigger reflow
        box.style.animation = 'fadeIn 0.3s ease';
        
        box.style.display = 'block';
        box.className = 'result-box ' + (isSuccess ? 'success' : 'error');
        
        titleEl.textContent = title;
        msgEl.innerHTML = message;
        detailsEl.innerHTML = details;
        
        // Play sound
        const soundId = isSuccess ? 'beepSuccess' : 'beepError';
        const sound = document.getElementById(soundId);
        sound.currentTime = 0;
        sound.play().catch(e => console.log("Audio error:", e));
        
        // Auto hide setelah 2.5 detik (lebih cepat dari sebelumnya)
        setTimeout(() => {
            if (box.style.display === 'block') {
                box.style.opacity = '0';
                box.style.transform = 'translateY(-10px)';
                setTimeout(() => {
                    box.style.display = 'none';
                    box.style.opacity = '1';
                    box.style.transform = 'translateY(0)';
                }, 300);
            }
        }, 2500);
    }
    
    // 9. Update counter
    function updateScanCounter() {
        document.getElementById('scanCounter').textContent = scanCount;
    }
    
    // ========== FUNGSI PROSES SCAN UTAMA ==========
    
    async function processScan(decodedText) {
        // Validasi format QR
        const validation = validateQRFormat(decodedText);
        if (!validation.valid) {
            showResult(false, "Format Error", validation.error);
            return false;
        }
        
        const { namaSiswa, kelasSiswa } = validation;
        const scanId = generateScanId(namaSiswa, kelasSiswa);
        
        // Cek duplikasi
        if (isRecentlyProcessed(scanId)) {
            console.log(`Scan duplikat terdeteksi: ${scanId}`);
            showResult(false, "Sudah Diproses", 
                `${namaSiswa} (${kelasSiswa}) sudah di-scan dalam 5 menit terakhir.`);
            return false;
        }
        
        // Update last scan time
        lastScanTime = Date.now();
        updateDebugInfo();
        
        try {
            showLoading(true);
            
            // Persiapkan Data
            const today = new Date();
            const tanggalStr = today.toISOString().split('T')[0];
            const jamStr = today.toLocaleTimeString('id-ID', { 
                hour: '2-digit', 
                minute: '2-digit',
                second: '2-digit'
            }).replace(/\./g, ':');
            
            const sanitizedNama = sanitizeKey(namaSiswa);
            
            console.log(`Memproses absensi: ${namaSiswa} | ${kelasSiswa} | ${tanggalStr} | ${jamStr}`);
            
            // A. Tulis ke Node Utama Absensi
            const absensiRef = ref(db, `absensi/${tanggalStr}/${kelasSiswa}/${sanitizedNama}`);
            
            await set(absensiRef, {
                status: "Hadir",
                waktu: jamStr,
                nama_lengkap: namaSiswa,
                pencatat: currentUser.email,
                mata_pelajaran: currentUserMapel,
                guru_role: currentUserRole,
                scan_timestamp: Date.now(),
                scan_method: "QR Code"
            });
            
            // Tambahkan ke processed scans
            addToProcessed(scanId);
            
            // Update counter
            scanCount++;
            updateScanCounter();
            
            // Tampilkan sukses
            showResult(true, `✅ Berhasil!`, 
                `<strong>${namaSiswa}</strong> (${kelasSiswa})<br>
                Hadir: ${jamStr}`,
                `Mapel: ${currentUserMapel.toUpperCase()} | Guru: ${currentUserRole}`
            );
            
            return true;
            
        } catch (error) {
            console.error("Gagal menyimpan absensi:", error);
            
            // Coba fallback ke node alternatif
            try {
                const fallbackRef = ref(db, `absensi_backup/${tanggalStr}/${Date.now()}`);
                await set(fallbackRef, {
                    nama: namaSiswa,
                    kelas: kelasSiswa,
                    waktu: jamStr,
                    guru: currentUser.email,
                    error: error.message,
                    timestamp: Date.now()
                });
                
                console.log("Data disimpan ke backup");
            } catch (backupError) {
                console.error("Gagal backup juga:", backupError);
            }
            
            showResult(false, "⚠️ Gagal Menyimpan", 
                `${namaSiswa} (${kelasSiswa})<br>
                Error: ${error.message || "Unknown error"}`);
            
            return false;
        } finally {
            showLoading(false);
            updateDebugInfo();
        }
    }
    
    // ========== QUEUE SYSTEM ==========
    
    function addToQueue(decodedText) {
        scanQueue.push(decodedText);
        updateDebugInfo();
        
        if (!isProcessing) {
            processQueue();
        }
    }
    
    async function processQueue() {
        if (isProcessing || scanQueue.length === 0) {
            return;
        }
        
        isProcessing = true;
        updateDebugInfo();
        
        // Pause scanner sementara
        if (html5QrcodeScanner && html5QrcodeScanner.pause) {
            html5QrcodeScanner.pause(true);
        }
        
        while (scanQueue.length > 0) {
            const nextScan = scanQueue.shift();
            await processScan(nextScan);
            
            // Delay antar proses untuk mengurangi load
            await new Promise(resolve => setTimeout(resolve, 300));
        }
        
        // Resume scanner
        if (html5QrcodeScanner && html5QrcodeScanner.resume) {
            html5QrcodeScanner.resume();
        }
        
        isProcessing = false;
        updateDebugInfo();
    }
    
    // ========== HANDLER SCAN ==========
    
    function onScanSuccess(decodedText, decodedResult) {
        console.log(`QR terdeteksi: ${decodedText}`);
        
        // Cek cooldown
        const now = Date.now();
        if (now - lastScanTime < SCAN_COOLDOWN) {
            console.log("Masih dalam cooldown, diabaikan");
            return;
        }
        
        // Tambahkan ke queue
        addToQueue(decodedText);
    }
    
    function onScanFailure(error) {
        // Hanya log error yang penting
        if (error && !error.message?.includes('NotFoundException')) {
            console.warn("Scan error:", error);
        }
    }
    
    // ========== MANUAL INPUT HANDLER ==========
    
    function setupManualInput() {
        const manualInput = document.getElementById('manualInput');
        const manualSubmit = document.getElementById('manualSubmit');
        const manualSection = document.getElementById('manualInputSection');
        
        // Tampilkan manual input setelah 10 detik jika scanner error
        setTimeout(() => {
            manualSection.style.display = 'block';
        }, 10000);
        
        manualSubmit.addEventListener('click', async () => {
            const value = manualInput.value.trim();
            if (!value) {
                showResult(false, "Input Kosong", "Masukkan format: NAMA|KELAS");
                return;
            }
            
            addToQueue(value);
            manualInput.value = '';
            
            // Fokus kembali ke input
            manualInput.focus();
        });
        
        manualInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                manualSubmit.click();
            }
        });
    }
    
    // ========== KAMERA HANDLER ==========
    
    async function setupCameraSelection() {
        try {
            const devices = await Html5Qrcode.getCameras();
            if (devices && devices.length > 1) {
                const select = document.getElementById('cameraSelect');
                const cameraSelector = document.getElementById('cameraSelector');
                
                devices.forEach(device => {
                    const option = document.createElement('option');
                    option.value = device.id;
                    option.text = device.label || `Kamera ${device.id}`;
                    select.appendChild(option);
                });
                
                cameraSelector.style.display = 'block';
                
                // Handler perubahan kamera
                select.addEventListener('change', async () => {
                    const cameraId = select.value;
                    if (html5QrcodeScanner) {
                        await html5QrcodeScanner.clear();
                        startScannerWithCamera(cameraId);
                    }
                });
            }
        } catch (error) {
            console.log("Tidak bisa akses daftar kamera:", error);
        }
    }
    
    // ========== START SCANNER ==========
    
    async function startScannerWithCamera(cameraId = null) {
        try {
            // Clear existing scanner
            const readerDiv = document.getElementById('reader');
            readerDiv.innerHTML = '';
            
            // Configuration
            const config = {
                fps: 15,
                qrbox: { width: 250, height: 250 },
                aspectRatio: 1.0,
                disableFlip: false,
                experimentalFeatures: {
                    useBarCodeDetectorIfSupported: true
                }
            };
            
            // Start scanner
            html5QrcodeScanner = new Html5QrcodeScanner(
                "reader", 
                config,
                false
            );
            
            await html5QrcodeScanner.render(
                onScanSuccess, 
                onScanFailure,
                { 
                    videoConstraints: cameraId ? { deviceId: { exact: cameraId } } : undefined
                }
            );
            
            console.log("Scanner berjalan dengan sukses");
            
        } catch (error) {
            console.error("Gagal memulai scanner:", error);
            showResult(false, "Scanner Error", 
                "Tidak bisa mengakses kamera.<br>Pastikan izin kamera diberikan.");
            
            // Tampilkan manual input lebih cepat
            document.getElementById('manualInputSection').style.display = 'block';
        }
    }
    
    function startScanner() {
        setupCameraSelection();
        startScannerWithCamera();
        setupManualInput();
    }
    
    // ========== MAIN AUTH & INIT ==========
    
    // 1. Cek Login & Role (DIPERTAHANKAN)
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            currentUser = user;
            
            // Ambil data user
            const userRef = ref(db, 'users/' + user.uid);
            const snapshot = await get(userRef);
            
            if (snapshot.exists()) {
                const userData = snapshot.val();
                currentUserRole = userData.role;
                
                // Tentukan mata pelajaran berdasarkan role
                if (currentUserRole.includes('PJOK')) {
                    currentUserMapel = 'pjok';
                } else if (currentUserRole.includes('PAI')) {
                    currentUserMapel = 'pai';
                } else {
                    currentUserMapel = 'akademik';
                }
                
                // Update info box
                document.getElementById('guruInfo').innerHTML = 
                    `<strong>${userData.nama || user.email}</strong> - ${currentUserRole}<br>
                     <small>Mata Pelajaran: ${currentUserMapel.toUpperCase()}</small>`;
                
                // Pastikan role sesuai
                const allowedRoles = ['ADMIN', 'GURU_KELAS', 'GURU_PJOK', 'GURU_PAI'];
                if (!allowedRoles.includes(currentUserRole)) {
                    alert("AKSES DITOLAK: Akun Anda (" + currentUserRole + ") tidak memiliki izin untuk scan.");
                    window.location.href = 'index.html';
                } else {
                    // Jika lolos, jalankan scanner
                    startScanner();
                    
                    // Update debug info setiap 5 detik
                    setInterval(updateDebugInfo, 5000);
                }
            } else {
                alert("Data pengguna tidak ditemukan!");
                window.location.href = 'index.html';
            }
        } else {
            window.location.href = 'index.html';
        }
    });
    
    // ========== CLEANUP PADA PAGE UNLOAD ==========
    
    window.addEventListener('beforeunload', () => {
        if (html5QrcodeScanner) {
            html5QrcodeScanner.clear().catch(e => console.log("Cleanup error:", e));
        }
    });
    
    // ========== KEYBOARD SHORTCUTS ==========
    
    document.addEventListener('keydown', (e) => {
        // F1 untuk toggle debug info
        if (e.key === 'F1') {
            e.preventDefault();
            const debugInfo = document.getElementById('debugInfo');
            debugInfo.style.display = debugInfo.style.display === 'none' ? 'block' : 'none';
        }
        
        // ESC untuk fokus ke manual input
        if (e.key === 'Escape') {
            document.getElementById('manualInput')?.focus();
        }
        
        // Ctrl+Shift+C untuk clear counter
        if (e.ctrlKey && e.shiftKey && e.key === 'C') {
            if (confirm("Reset scan counter?")) {
                scanCount = 0;
                updateScanCounter();
                processedScans.clear();
            }
        }
    });
    
    // ========== INITIAL DEBUG ==========
    console.log("Scanner Premium v2.0 loaded");
    console.log("Features: Queue System, Anti-Duplicate, Camera Selector");
    
</script>

</body>
</html>