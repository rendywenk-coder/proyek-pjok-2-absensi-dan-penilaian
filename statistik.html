<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Statistik Sekolah - SDN Rawabuntu 03</title>
    <link rel="stylesheet" href="style_main.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .filter-container { background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .chart-box { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-top: 20px; }
        select, input { padding: 10px; border: 1px solid #ddd; border-radius: 8px; width: 100%; margin-top: 5px; }
        .grid-filter { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
    </style>
</head>
<body>
    <header class="top-bar">
        <a href="index.html" style="color:white; text-decoration:none;"><i class="fa-solid fa-arrow-left"></i> Kembali</a>
        <h3>Statistik Admin Global</h3>
    </header>

    <div class="container">
        <div class="filter-container">
            <div class="form-group">
                <label><b>Pilih Kategori:</b></label>
                <select id="katStat">
                    <option value="akademik">Guru Kelas (Akademik)</option>
                    <option value="pjok">Guru PJOK</option>
                    <option value="pai">Guru PAI</option>
                </select>
            </div>

            <div class="grid-filter" style="margin-top:15px;">
                <div>
                    <label><b>Pilih Tahun:</b></label>
                    <select id="tahunStat">
                        <option value="2026">2026</option>
                        <option value="2025">2025</option>
                    </select>
                </div>
                <div>
                    <label><b>Pilih Bulan:</b></label>
                    <select id="bulanStat">
                        <option value="ALL">Semua Bulan (Tahunan)</option>
                        <option value="01">Januari</option><option value="02">Februari</option>
                        <option value="03">Maret</option><option value="04">April</option>
                        <option value="05">Mei</option><option value="06">Juni</option>
                        <option value="07">Juli</option><option value="08">Agustus</option>
                        <option value="09">September</option><option value="10">Oktober</option>
                        <option value="11">November</option><option value="12">Desember</option>
                    </select>
                </div>
            </div>

            <button onclick="updateGrafik()" class="btn-primary" style="width:100%; font-weight:bold;">TAMPILKAN STATISTIK</button>
        </div>

        <div class="chart-box">
            <canvas id="canvasStatistik"></canvas>
        </div>
    </div>

    <script type="module">
        import { db, auth, ref, onValue, get, child } from './config_firebase.js';

        let myChart = null;

        window.updateGrafik = async function() {
            const kategori = document.getElementById('katStat').value;
            const tahun = document.getElementById('tahunStat').value;
            const bulan = document.getElementById('bulanStat').value;
            
            const area = document.getElementById('canvasStatistik').getContext('2d');
            
            // Ambil data absensi sebagai contoh statistik utama
            const absensiRef = ref(db, 'absensi');
            const snapshot = await get(absensiRef);
            
            let dataRekap = {}; // Format: { "1A": total_kehadiran, "1B": total }
            
            if (snapshot.exists()) {
                const allData = snapshot.val();
                
                Object.keys(allData).forEach(tgl => {
                    // Cek filter tahun dan bulan
                    // Format tgl biasanya YYYY-MM-DD
                    if (tgl.startsWith(tahun)) {
                        if (bulan === "ALL" || tgl.split('-')[1] === bulan) {
                            
                            const perHari = allData[tgl];
                            Object.keys(perHari).forEach(kelas => {
                                if (!dataRekap[kelas]) dataRekap[kelas] = 0;
                                
                                // Hitung total siswa yang memiliki status di hari tersebut
                                dataRekap[kelas] += Object.keys(perHari[kelas]).length;
                            });
                        }
                    }
                });
            }

            // Hancurkan chart lama jika ada agar tidak tumpang tindih
            if (myChart) myChart.destroy();

            const labels = Object.keys(dataRekap).sort();
            const values = labels.map(l => dataRekap[l]);

            myChart = new Chart(area, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: `Jumlah Input Absensi (${kategori.toUpperCase()})`,
                        data: values,
                        backgroundColor: '#3b82f6',
                        borderRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'top' }
                    }
                }
            });
        };

        // Load awal saat halaman dibuka
        document.addEventListener('DOMContentLoaded', () => {
            updateGrafik();
        });
    </script>
</body>
</html>