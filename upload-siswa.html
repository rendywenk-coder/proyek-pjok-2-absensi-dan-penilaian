<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload Massal Siswa - SDN Rawabuntu 03</title>
    <link rel="stylesheet" href="style_main.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f7fa;
            margin: 0;
            padding: 0;
        }
        
        .top-bar {
            background: linear-gradient(135deg, #4CAF50 0%, #2E7D32 100%);
            color: white;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .top-bar a {
            color: white;
            text-decoration: none;
            margin-right: 20px;
            font-size: 16px;
        }
        
        .top-bar h3 {
            margin: 0;
            font-size: 18px;
        }
        
        .container {
            max-width: 800px;
            margin: 30px auto;
            padding: 0 20px;
        }
        
        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 16px;
        }
        
        select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 15px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            transition: border-color 0.3s;
            box-sizing: border-box;
        }
        
        select:focus, textarea:focus {
            border-color: #4CAF50;
            outline: none;
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
        }
        
        select {
            background-color: white;
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%23333' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 40px;
        }
        
        textarea {
            height: 280px;
            line-height: 1.5;
            resize: vertical;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #4CAF50 0%, #2E7D32 100%);
            color: white;
            border: none;
            padding: 16px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.3);
        }
        
        .btn-primary:disabled {
            background: #cccccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .btn-primary i {
            font-size: 18px;
        }
        
        .info-box {
            background-color: #e8f5e9;
            border-left: 4px solid #4CAF50;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .info-box i {
            color: #2E7D32;
            margin-right: 8px;
        }
        
        .error-box {
            background-color: #ffebee;
            border-left: 4px solid #f44336;
            padding: 15px;
            margin-top: 20px;
            border-radius: 6px;
            font-size: 14px;
            display: none;
        }
        
        .success-box {
            background-color: #e8f5e9;
            border-left: 4px solid #4CAF50;
            padding: 15px;
            margin-top: 20px;
            border-radius: 6px;
            font-size: 14px;
            display: none;
        }
        
        .counter {
            font-size: 13px;
            color: #666;
            margin-top: 5px;
            text-align: right;
        }
        
        .example {
            background-color: #f9f9f9;
            border: 1px dashed #ddd;
            padding: 12px;
            margin-top: 10px;
            border-radius: 6px;
            font-size: 13px;
            color: #666;
            line-height: 1.6;
        }
        
        .loading {
            display: inline-block;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .login-warning {
            background-color: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 6px;
            font-size: 14px;
            display: none;
        }
    </style>
</head>
<body>
    <header class="top-bar">
        <a href="index.html"><i class="fa-solid fa-arrow-left"></i> Kembali</a>
        <h3>Upload Massal Siswa Per Kelas</h3>
    </header>

    <div class="container">
        <div class="card">
            <div class="login-warning" id="loginWarning">
                <i class="fa-solid fa-triangle-exclamation"></i>
                <strong>Peringatan:</strong> Anda harus login sebagai ADMIN untuk mengupload data siswa.
            </div>
            
            <div class="info-box" id="loginInfo">
                <i class="fa-solid fa-circle-info"></i>
                <strong>Petunjuk:</strong> Pilih kelas, lalu tempel daftar nama siswa dari Excel. Pastikan setiap nama dalam baris terpisah.
            </div>
            
            <div class="form-group">
                <label for="pilihKelas"><i class="fa-solid fa-chalkboard"></i> 1. Pilih Kelas:</label>
                <select id="pilihKelas">
                    <option value="">-- Pilih Kelas --</option>
                    <option value="1A">Kelas 1A</option>
                    <option value="1B">Kelas 1B</option>
                    <option value="1C">Kelas 1C</option>
                    <option value="1D">Kelas 1D</option>
                    <option value="1E">Kelas 1E</option>
                    <option value="2A">Kelas 2A</option>
                    <option value="2B">Kelas 2B</option>
                    <option value="2C">Kelas 2C</option>
                    <option value="2D">Kelas 2D</option>
                    <option value="2E">Kelas 2E</option>
                    <option value="3A">Kelas 3A</option>
                    <option value="3B">Kelas 3B</option>
                    <option value="3C">Kelas 3C</option>
                    <option value="3D">Kelas 3D</option>
                    <option value="3E">Kelas 3E</option>
                    <option value="4A">Kelas 4A</option>
                    <option value="4B">Kelas 4B</option>
                    <option value="4C">Kelas 4C</option>
                    <option value="4D">Kelas 4D</option>
                    <option value="4E">Kelas 4E</option>
                    <option value="4F">Kelas 4F</option>
                    <option value="5A">Kelas 5A</option>
                    <option value="5B">Kelas 5B</option>
                    <option value="5C">Kelas 5C</option>
                    <option value="5D">Kelas 5D</option>
                    <option value="5E">Kelas 5E</option>
                    <option value="6A">Kelas 6A</option>
                    <option value="6B">Kelas 6B</option>
                    <option value="6C">Kelas 6C</option>
                    <option value="6D">Kelas 6D</option>
                    <option value="6E">Kelas 6E</option>
                </select>
            </div>

            <div class="form-group">
                <label for="listNama"><i class="fa-solid fa-users"></i> 2. Tempel Daftar Nama dari Excel:</label>
                <textarea id="listNama" placeholder="Contoh format:
ACHMAD BUDI
SITI AMINAH
WAHYU NUGROHO

Copy paste langsung dari kolom nama di Excel..."></textarea>
                <div class="counter" id="counter">0 nama</div>
                
                <div class="example">
                    <strong>Contoh format yang benar:</strong><br>
                    ADINDA JIHAN NURHALIMAH<br>
                    AFIFAH HILYA MAFISAH<br>
                    AISYAH AZZAHRA<br>
                    ALLANA FARANISA PUTRI
                </div>
            </div>

            <button onclick="prosesSimpan()" id="btnSimpan" class="btn-primary">
                <i class="fa-solid fa-cloud-arrow-up"></i> SIMPAN DATA SATU KELAS
            </button>
            
            <div class="success-box" id="successBox">
                <i class="fa-solid fa-circle-check"></i>
                <span id="successText"></span>
            </div>
            
            <div class="error-box" id="errorBox">
                <i class="fa-solid fa-circle-exclamation"></i>
                <span id="errorText"></span>
            </div>
        </div>
    </div>

    <script type="module">
        import { db, ref, set, auth, get } from './config_firebase.js';

        let isAdmin = false;
        let currentUser = null;

        // Cek status login saat halaman dimuat
        auth.onAuthStateChanged(async (user) => {
            currentUser = user;
            const loginWarning = document.getElementById('loginWarning');
            const loginInfo = document.getElementById('loginInfo');
            const btnSimpan = document.getElementById('btnSimpan');
            const pilihKelas = document.getElementById('pilihKelas');
            const listNama = document.getElementById('listNama');

            if (user) {
                console.log("User logged in:", user.uid);
                // Cek role user
                try {
                    const userRef = ref(db, `users/${user.uid}`);
                    const snapshot = await get(userRef);
                    if (snapshot.exists()) {
                        const userData = snapshot.val();
                        console.log("User role:", userData.role);
                        
                        if (userData.role === 'ADMIN') {
                            isAdmin = true;
                            loginWarning.style.display = 'none';
                            loginInfo.style.display = 'block';
                            btnSimpan.disabled = false;
                            pilihKelas.disabled = false;
                            listNama.disabled = false;
                        } else {
                            isAdmin = false;
                            loginWarning.innerHTML = '<i class="fa-solid fa-triangle-exclamation"></i> <strong>Akses Ditolak:</strong> Hanya user dengan role ADMIN yang dapat mengupload data siswa.';
                            loginWarning.style.display = 'block';
                            loginInfo.style.display = 'none';
                            btnSimpan.disabled = true;
                            pilihKelas.disabled = true;
                            listNama.disabled = true;
                        }
                    } else {
                        showError("Data user tidak ditemukan di database!");
                    }
                } catch (error) {
                    console.error("Error checking user role:", error);
                    showError("Gagal memeriksa role user: " + error.message);
                }
            } else {
                isAdmin = false;
                loginWarning.innerHTML = '<i class="fa-solid fa-triangle-exclamation"></i> <strong>Belum Login:</strong> Silakan login terlebih dahulu untuk mengupload data siswa.';
                loginWarning.style.display = 'block';
                loginInfo.style.display = 'none';
                btnSimpan.disabled = true;
                pilihKelas.disabled = true;
                listNama.disabled = true;
            }
        });

        // Update counter saat mengetik
        document.getElementById('listNama').addEventListener('input', function() {
            const text = this.value.trim();
            const names = text.split(/\n/).map(n => n.trim()).filter(n => n !== "");
            document.getElementById('counter').textContent = names.length + ' nama';
        });

        // Auto-focus ke textarea setelah memilih kelas
        document.getElementById('pilihKelas').addEventListener('change', function() {
            if (this.value !== '') {
                setTimeout(() => {
                    document.getElementById('listNama').focus();
                }, 100);
            }
        });

        window.prosesSimpan = async function() {
            // Cek login status dulu
            if (!currentUser) {
                showError("Silakan login terlebih dahulu!");
                return;
            }
            
            if (!isAdmin) {
                showError("Hanya ADMIN yang dapat mengupload data siswa!");
                return;
            }

            const kls = document.getElementById('pilihKelas').value;
            const teks = document.getElementById('listNama').value.trim();
            const btn = document.getElementById('btnSimpan');
            const successBox = document.getElementById('successBox');
            const errorBox = document.getElementById('errorBox');

            // Reset boxes
            successBox.style.display = 'none';
            errorBox.style.display = 'none';

            // Validasi
            if (!kls) {
                showError("Silakan pilih kelas terlebih dahulu!");
                document.getElementById('pilihKelas').focus();
                return;
            }
            
            if (!teks) {
                showError("Silakan tempel daftar nama siswa!");
                document.getElementById('listNama').focus();
                return;
            }

            // Bersihkan data: hapus angka dan karakter khusus
            const daftarNama = teks.split(/\n/)
                .map(n => n.trim())
                .filter(n => n !== "")
                .map(nama => {
                    // Hapus nomor urut di awal (contoh: "28. ", "29. ", dll)
                    return nama.replace(/^\d+\.\s*/, '')
                               .replace(/^\d+\)\s*/, '')
                               .replace(/^\s*\d+\s*[-.]?\s*/, '')
                               .replace(/^[0-9]+\s*/, '')
                               .trim();
                })
                .filter(nama => nama.length > 0);

            if (daftarNama.length === 0) {
                showError("Tidak ada nama yang valid ditemukan! Pastikan formatnya benar.");
                return;
            }

            // Konfirmasi
            if(!confirm(`Anda akan menyimpan ${daftarNama.length} siswa ke kelas ${kls}.\n\nLanjutkan?`)) {
                return;
            }

            // Disable button dan show loading
            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-spinner loading"></i> Menyimpan...';

            try {
                console.log("Memulai penyimpanan untuk kelas:", kls);
                console.log("Jumlah siswa:", daftarNama.length);
                
                let successCount = 0;
                let errorCount = 0;
                let errorMessages = [];
                
                // Simpan satu per satu
                for (let i = 0; i < daftarNama.length; i++) {
                    try {
                        let noAbsen = (i + 1).toString().padStart(2, '0');
                        let namaSiswa = daftarNama[i];
                        
                        // Data yang DIPERLUKAN oleh Firebase Rules
                        const dataSiswa = {
                            nama: namaSiswa,
                            kelas: kls,
                            no_absen: noAbsen,
                            // Optional fields (tidak divalidasi di rules)
                            nis: noAbsen,
                            created_at: new Date().toISOString(),
                            updated_at: new Date().toISOString()
                        };
                        
                        console.log(`Menyimpan siswa ${i+1}: ${noAbsen}. ${namaSiswa}`);
                        
                        await set(ref(db, `siswa/${kls}/${noAbsen}`), dataSiswa);
                        successCount++;
                        
                        // Update progress setiap 5 siswa
                        if ((i + 1) % 5 === 0 || i === daftarNama.length - 1) {
                            btn.innerHTML = `<i class="fa-solid fa-spinner loading"></i> Menyimpan ${i + 1}/${daftarNama.length}...`;
                        }
                        
                    } catch (err) {
                        console.error(`Gagal menyimpan siswa ke-${i + 1}:`, err);
                        errorCount++;
                        errorMessages.push(`Siswa ${i+1}: ${err.message}`);
                        
                        // Jika error karena permission, hentikan proses
                        if (err.message.includes("PERMISSION_DENIED") || err.code === "PERMISSION_DENIED") {
                            throw new Error("PERMISSION_DENIED: Anda tidak memiliki izin untuk menulis data. Pastikan:\n1. Anda login sebagai ADMIN\n2. Rules Firebase sudah diperbarui");
                        }
                    }
                }
                
                // Tampilkan hasil
                if (errorCount === 0) {
                    showSuccess(`✅ Berhasil! ${successCount} siswa kelas ${kls} telah disimpan.`);
                    document.getElementById('listNama').value = '';
                    document.getElementById('counter').textContent = '0 nama';
                } else if (successCount > 0) {
                    showSuccess(`⚠️ Proses selesai! ${successCount} berhasil, ${errorCount} gagal dari total ${daftarNama.length} siswa.`);
                } else {
                    showError(`❌ Gagal menyimpan semua data. ${errorCount} error terjadi.`);
                }
                
            } catch (error) {
                console.error("Error utama:", error);
                
                // Tampilkan pesan error yang lebih spesifik
                let errorMessage = error.message || "Terjadi kesalahan saat menyimpan data.";
                
                if (error.message.includes("PERMISSION_DENIED")) {
                    errorMessage = `PERMISSION_DENIED: Izin ditolak!\n\nPenyebab:\n1. User tidak login sebagai ADMIN\n2. Rules Firebase belum diperbarui\n3. User tidak memiliki izin write ke path /siswa\n\nSolusi:\n1. Login dengan akun ADMIN\n2. Update Rules Firebase di Console\n3. Pastikan rules untuk /siswa mengizinkan ADMIN`;
                } else if (error.message.includes("network") || error.message.includes("offline")) {
                    errorMessage = "Gagal terhubung ke server. Periksa koneksi internet Anda.";
                }
                
                showError(errorMessage);
            } finally {
                // Reset button
                btn.disabled = false;
                btn.innerHTML = '<i class="fa-solid fa-cloud-arrow-up"></i> SIMPAN DATA SATU KELAS';
            }
        };

        function showSuccess(message) {
            const successBox = document.getElementById('successBox');
            const successText = document.getElementById('successText');
            successText.innerHTML = message;
            successBox.style.display = 'block';
            
            // Scroll ke success message
            setTimeout(() => {
                successBox.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }, 100);
        }

        function showError(message) {
            const errorBox = document.getElementById('errorBox');
            const errorText = document.getElementById('errorText');
            errorText.innerHTML = message.replace(/\n/g, '<br>');
            errorBox.style.display = 'block';
            
            // Scroll ke error message
            setTimeout(() => {
                errorBox.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }, 100);
        }

        // Enable/disable form based on login status
        function updateFormAccess(enabled) {
            document.getElementById('pilihKelas').disabled = !enabled;
            document.getElementById('listNama').disabled = !enabled;
            document.getElementById('btnSimpan').disabled = !enabled;
        }
    </script>
</body>
</html>