
<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rekap Nilai Admin (Realtime) - SDN Rawabuntu 03</title>
    <link rel="stylesheet" href="style_main.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { background: #f0f2f5; font-family: 'Poppins', sans-serif; padding: 20px; }
        .container { max-width: 1600px; margin: 0 auto; }
        
        .header-card { background: white; padding: 25px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .controls { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px; }
        
        select, button { padding: 12px; border-radius: 8px; border: 1px solid #ddd; width: 100%; font-size: 14px; }
        button { cursor: pointer; background: #1e40af; color: white; border: none; font-weight: 500; transition: 0.3s; }
        button:hover { background: #1e3a8a; }
        
        .table-responsive { overflow-x: auto; background: white; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        table { width: 100%; border-collapse: collapse; min-width: 1400px; }
        th, td { padding: 12px 15px; border-bottom: 1px solid #eee; text-align: center; font-size: 14px; }
        th { background: #f8fafc; color: #1e293b; font-weight: 600; white-space: nowrap; border-bottom: 2px solid #e2e8f0; }
        
        /* Nilai Akhir Styles */
        .nilai-akhir-cell {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            font-weight: 700;
            border-left: 3px solid #0369a1;
            border-right: 3px solid #0369a1;
        }
        
        .badge-absen { padding: 5px 10px; border-radius: 20px; font-weight: bold; font-size: 12px; }
        .bg-s { background: #fff7ed; color: #d97706; }
        .bg-i { background: #eff6ff; color: #2563eb; }
        .bg-a { background: #fef2f2; color: #dc2626; }
        
        .grade-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 5px;
        }
        
        .grade-A { background: #dcfce7; color: #166534; }
        .grade-B { background: #dbeafe; color: #1e40af; }
        .grade-C { background: #fef3c7; color: #92400e; }
        .grade-D { background: #fee2e2; color: #991b1b; }
        .grade-E { background: #f3f4f6; color: #6b7280; }
        
        .loading { display: none; text-align: center; padding: 40px; }
        
        .danger-zone {
            margin-top: 20px; padding: 15px; border: 1px solid #fca5a5; 
            background: #fef2f2; border-radius: 8px; display: flex; align-items: center; gap: 10px; flex-wrap: wrap;
        }
        .btn-delete { background: #ef4444; color: white; }
        .btn-delete:hover { background: #dc2626; }
        .btn-delete:disabled { background: #cbd5e1; cursor: not-allowed; }
        
        .btn-sync { background: #3b82f6; color: white; }
        .btn-sync:hover { background: #2563eb; }
        
        .sync-info {
            font-size: 12px;
            color: #64748b;
            margin-top: 5px;
            padding: 8px;
            background: #f8fafc;
            border-radius: 6px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .realtime-badge {
            background: #10b981;
            color: white;
            font-size: 9px;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 5px;
        }
        
        /* Summary Info */
        .summary-box {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border-left: 4px solid #0369a1;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            font-size: 12px;
            color: #0369a1;
        }
        
        .summary-item {
            display: inline-block;
            margin-right: 20px;
            padding: 5px 10px;
            background: white;
            border-radius: 6px;
            border: 1px solid #bae6fd;
        }
        
        .summary-label {
            font-weight: 600;
            color: #64748b;
        }
        
        .summary-value {
            font-weight: 700;
            color: #0369a1;
            margin-left: 5px;
        }
        
        /* Blueprint Info */
        .blueprint-info {
            background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
            border-left: 4px solid #f59e0b;
            border-radius: 8px;
            padding: 12px 16px;
            margin-top: 15px;
            font-size: 12px;
            color: #92400e;
        }
        
        .formula-box {
            background: white;
            border: 1px solid #fcd34d;
            border-radius: 6px;
            padding: 8px 12px;
            margin-top: 8px;
            font-family: monospace;
            font-size: 11px;
            color: #92400e;
        }
        
        /* Progress Bar */
        .progress-container {
            margin-top: 10px;
            background: #e2e8f0;
            border-radius: 10px;
            overflow: hidden;
            height: 8px;
            display: none;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #ef4444, #dc2626);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .reset-info {
            font-size: 11px;
            color: #64748b;
            margin-top: 5px;
            padding: 5px 10px;
            background: #f8fafc;
            border-radius: 5px;
            border-left: 3px solid #ef4444;
        }
        
        /* Status Messages */
        .status-message {
            padding: 10px 15px;
            border-radius: 8px;
            margin-top: 10px;
            font-size: 13px;
            display: none;
            align-items: center;
            gap: 10px;
            width: 100%;
        }
        
        .status-success {
            background: #dcfce7;
            color: #166534;
            border-left: 4px solid #10b981;
        }
        
        .status-error {
            background: #fef2f2;
            color: #dc2626;
            border-left: 4px solid #ef4444;
        }
        
        .status-warning {
            background: #fffbeb;
            color: #92400e;
            border-left: 4px solid #f59e0b;
        }
        
        .permission-check {
            font-size: 11px;
            color: #3b82f6;
            background: #eff6ff;
            padding: 5px 10px;
            border-radius: 5px;
            margin-top: 5px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        /* Reset Strategy Buttons */
        .reset-strategy {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        
        .btn-reset-soft {
            background: #f59e0b;
            color: white;
            padding: 8px 15px;
            border-radius: 6px;
            font-size: 12px;
            border: none;
            cursor: pointer;
        }
        
        .btn-reset-hard {
            background: #dc2626;
            color: white;
            padding: 8px 15px;
            border-radius: 6px;
            font-size: 12px;
            border: none;
            cursor: pointer;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header-card">
        <h2 style="color: #1e40af; margin-top:0;"><i class="fa-solid fa-chart-pie"></i> Rekap Nilai & Absensi (Realtime)</h2>
        <p style="color: #64748b; margin-bottom: 0;">Data kehadiran dan nilai akhir dihitung otomatis berdasarkan blueprint penilaian REVISI.</p>
        
        <div class="controls">
            <select id="pilihKelas">
                 <option value="">-- Pilih Kelas --</option>
                        <option value="1A">Kelas 1A</option><option value="1B">Kelas 1B</option><option value="1C">Kelas 1C</option><option value="1D">Kelas 1D</option>
                        <option value="2A">Kelas 2A</option><option value="2B">Kelas 2B</option><option value="2C">Kelas 2C</option><option value="2D">Kelas 2D</option><option value="2E">Kelas 2E</option>
                        <option value="3A">Kelas 3A</option><option value="3B">Kelas 3B</option><option value="3C">Kelas 3C</option><option value="3D">Kelas 3D</option><option value="3E">Kelas 3E</option>
                        <option value="4A">Kelas 4A</option><option value="4B">Kelas 4B</option><option value="4C">Kelas 4C</option><option value="4D">Kelas 4D</option><option value="4E">Kelas 4E</option><option value="4F">Kelas 4F</option>
                        <option value="5A">Kelas 5A</option><option value="5B">Kelas 5B</option><option value="5C">Kelas 5C</option><option value="5D">Kelas 5D</option><option value="5E">Kelas 5E</option>
                        <option value="6A">Kelas 6A</option><option value="6B">Kelas 6B</option><option value="6C">Kelas 6C</option><option value="6D">Kelas 6D</option><option value="6E">Kelas 6E</option>
            </select>
            <select id="pilihMapel">
                <option value="akademik">Akademik (Guru Kelas)</option>
                <option value="pjok">PJOK</option>
                <option value="pai">PAI</option>
            </select>
            <select id="pilihSemester">
                <option value="ganjil">Semester Ganjil</option>
                <option value="genap">Semester Genap</option>
            </select>
            <button onclick="loadData()"><i class="fa-solid fa-magnifying-glass"></i> Tampilkan</button>
            <button onclick="exportExcel()" style="background:#10b981;"><i class="fa-solid fa-file-excel"></i> Excel</button>
            <button onclick="window.location.href='index.html'" style="background:#64748b;">Kembali</button>
        </div>

        <div class="blueprint-info">
            <i class="fa-solid fa-calculator"></i>
            <div>
                <strong>Blueprint Penilaian REVISI:</strong>
                <div class="formula-box">
                    Nilai Akhir = (65% Rata-rata N1-N4) + (35% STS/SAS) - Penalti Kehadiran<br>
                    Penalti: Alfa = 0.5 poin per alfa (maksimal 5%) | Ijin/Sakit >10 kali = 2%
                </div>
            </div>
        </div>

        <div class="danger-zone">
            <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap; width: 100%;">
                <input type="checkbox" id="confirmReset" style="width: 20px; height: 20px;">
                <label for="confirmReset" style="margin:0; color: #b91c1c; cursor:pointer; flex: 1;">
                    Saya yakin ingin mereset NILAI sesuai filter di atas.
                </label>
                <button id="btnReset" onclick="resetNilaiAman()" class="btn-delete" disabled style="width: auto; padding: 10px 20px;">
                    <i class="fa-solid fa-trash-can"></i> Reset Nilai (AMAN)
                </button>
            </div>
            
            <!-- Reset Strategy Buttons -->
            <div class="reset-strategy">
                <button onclick="resetNilaiSoft()" class="btn-reset-soft" title="Reset nilai tanpa menghapus data">
                    <i class="fa-solid fa-rotate-left"></i> Reset Soft (Set ke 0)
                </button>
                <button onclick="resetNilaiHard()" class="btn-reset-hard" title="Reset nilai dan hapus data">
                    <i class="fa-solid fa-broom"></i> Reset Hard (Hapus Data)
                </button>
            </div>
            
            <button onclick="syncOldData()" class="btn-sync" style="width: auto; padding: 10px 20px;">
                <i class="fa-solid fa-sync"></i> Sync Data Lama
            </button>
            
            <div class="sync-info">
                <i class="fa-solid fa-circle-info"></i>
                <span><strong>Sistem Penilaian REVISI:</strong> Nilai Akhir = 65% Subtest + 35% STS/SAS - Penalti Kehadiran</span>
            </div>
            
            <div class="reset-info">
                <i class="fa-solid fa-triangle-exclamation"></i>
                <span><strong>PERHATIAN:</strong> Reset Soft: Set nilai ke 0. Reset Hard: Hapus data permanen.</span>
            </div>
            
            <!-- Status Message -->
            <div id="statusMessage" class="status-message">
                <i class="fa-solid fa-circle-info"></i>
                <span id="statusText">Status akan muncul di sini</span>
            </div>
            
            <!-- Progress Bar -->
            <div class="progress-container" id="resetProgress">
                <div class="progress-bar" id="resetProgressBar"></div>
            </div>
            
            <!-- Permission Check Info -->
            <div id="permissionInfo" class="permission-check" style="display: none;">
                <i class="fa-solid fa-shield-check"></i>
                <span id="permissionText">Memeriksa izin...</span>
            </div>
        </div>
    </div>

    <div id="loading" class="loading">
        <i class="fa-solid fa-spinner fa-spin fa-2x" style="color: #1e40af;"></i>
        <p>Sedang menghitung nilai akhir...</p>
    </div>

    <!-- Summary Box -->
    <div id="summaryBox" class="summary-box" style="display: none;">
        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap;">
            <div>
                <strong>Sistem Penilaian Otomatis (REVISI)</strong>
                <div style="font-size: 11px; color: #64748b; margin-top: 5px;">
                    <span class="summary-item">
                        <span class="summary-label">N1-N4:</span>
                        <span class="summary-value">65%</span>
                    </span>
                    <span class="summary-item">
                        <span class="summary-label" id="stsSasLabel">STS:</span>
                        <span class="summary-value">35%</span>
                    </span>
                    <span class="summary-item">
                        <span class="summary-label">Penalti Alfa:</span>
                        <span class="summary-value">0.5/alfa (max 5%)</span>
                    </span>
                    <span class="summary-item">
                        <span class="summary-label">Ijin/Sakit >10:</span>
                        <span class="summary-value">2%</span>
                    </span>
                </div>
            </div>
            <div style="text-align: right;">
                <div style="font-size: 11px; color: #64748b;">
                    <span class="summary-item">
                        <span class="summary-label">Total Siswa:</span>
                        <span class="summary-value" id="totalSiswa">0</span>
                    </span>
                    <span class="summary-item">
                        <span class="summary-label">Rata-rata:</span>
                        <span class="summary-value" id="rataNilai">0</span>
                    </span>
                    <span class="summary-item">
                        <span class="summary-label">Tertinggi:</span>
                        <span class="summary-value" id="nilaiTertinggi">0</span>
                    </span>
                    <span class="summary-item">
                        <span class="summary-label">Terendah:</span>
                        <span class="summary-value" id="nilaiTerendah">0</span>
                    </span>
                </div>
            </div>
        </div>
    </div>

    <div class="table-responsive">
        <table id="nilaiTable">
            <thead>
                <tr>
                    <th rowspan="2">No</th>
                    <th rowspan="2" style="text-align:left;">Nama Siswa</th>
                    <th colspan="4" style="background:#eff6ff;">Nilai Formatif</th>
                    <th rowspan="2" style="background:#eff6ff;" id="stsHeader">STS</th>
                    <th colspan="3" style="background:#fff7ed;">Total Kehadiran</th>
                    <th colspan="3" style="background:#f0f9ff; color:#0369a1;">Nilai Akhir</th>
                    <th colspan="2" style="background:#fef7ed; color:#d97706;">Detail Penalti</th>
                </tr>
                <tr>
                    <!-- Nilai Formatif -->
                    <th style="font-size:12px;">N1</th>
                    <th style="font-size:12px;">N2</th>
                    <th style="font-size:12px;">N3</th>
                    <th style="font-size:12px;">N4</th>
                    
                    <!-- Kehadiran -->
                    <th style="font-size:12px; color:#d97706;">S</th>
                    <th style="font-size:12px; color:#2563eb;">I</th>
                    <th style="font-size:12px; color:#dc2626;">A</th>
                    
                    <!-- Nilai Akhir -->
                    <th style="font-size:12px; color:#0369a1;">Nilai</th>
                    <th style="font-size:12px; color:#0369a1;">Huruf</th>
                    <th style="font-size:12px; color:#0369a1;">Keterangan</th>
                    
                    <!-- Detail Penalti -->
                    <th style="font-size:12px; color:#d97706;">Alfa</th>
                    <th style="font-size:12px; color:#2563eb;">Ijin/Sakit</th>
                </tr>
            </thead>
            <tbody id="tableBody">
                <tr><td colspan="16" style="padding:30px; color:#94a3b8;">Silakan pilih filter dan klik Tampilkan</td></tr>
            </tbody>
        </table>
    </div>
</div>

<script type="module">
    import { 
        db, auth, onAuthStateChanged, ref, get, set, update,
        syncAllOldData, getAdminRekapData, hitungRekapAbsensi, getUserData,
        hitungNilaiAkhir, checkWritePermission, checkDeletePermission
    } from './config_firebase.js';

    document.getElementById('confirmReset').addEventListener('change', function() {
        document.getElementById('btnReset').disabled = !this.checked;
    });

    let currentUserRole = null;
    let currentUserId = null;
    let currentUserEmail = null;
    
    onAuthStateChanged(auth, async (user) => {
        if (!user) {
            window.location.href = 'index.html';
            return;
        }
        
        currentUserId = user.uid;
        currentUserEmail = user.email;
        
        try {
            const userData = await getUserData(user.uid);
            if (userData) {
                currentUserRole = userData.role;
                
                if (currentUserRole !== 'ADMIN') {
                    alert("Hanya admin yang bisa mengakses halaman ini.");
                    window.location.href = 'index.html';
                } else {
                    // Tampilkan info permission untuk admin
                    document.getElementById('permissionInfo').style.display = 'flex';
                    document.getElementById('permissionText').textContent = `Status: Admin (Full Access)`;
                }
            }
        } catch (error) {
            console.error("Error getting user data:", error);
        }
    });

    window.loadData = loadData;
    window.exportExcel = exportExcel;
    window.resetNilaiAman = resetNilaiAman;
    window.resetNilaiSoft = resetNilaiSoft;
    window.resetNilaiHard = resetNilaiHard;
    window.syncOldData = syncOldData;

    // Helper: Get color from grade
    function getColorFromGrade(grade) {
        const colors = {
            'A': '#166534',
            'B': '#1e40af',
            'C': '#92400e',
            'D': '#991b1b',
            'E': '#6b7280'
        };
        return colors[grade] || '#6b7280';
    }

    // Update STS/SAS label berdasarkan semester
    function updateStsLabels() {
        const semester = document.getElementById('pilihSemester').value;
        const stsHeader = document.getElementById('stsHeader');
        const stsSasLabel = document.getElementById('stsSasLabel');
        
        if (semester === 'ganjil') {
            stsHeader.textContent = 'STS';
            stsHeader.title = 'Sumatif Tengah Semester (Semester Ganjil)';
            stsSasLabel.textContent = 'STS:';
        } else {
            stsHeader.textContent = 'SAS';
            stsHeader.title = 'Sumatif Akhir Semester (Semester Genap)';
            stsSasLabel.textContent = 'SAS:';
        }
    }

    // Fungsi untuk menampilkan status message
    function showStatus(message, type = 'info') {
        const statusEl = document.getElementById('statusMessage');
        const statusText = document.getElementById('statusText');
        
        statusText.textContent = message;
        statusEl.className = `status-message status-${type}`;
        statusEl.style.display = 'flex';
        
        // Auto hide setelah 5 detik untuk tipe success
        if (type === 'success') {
            setTimeout(() => {
                statusEl.style.display = 'none';
            }, 5000);
        }
    }

    // Fungsi untuk update progress bar
    function updateProgressBar(percent) {
        document.getElementById('resetProgressBar').style.width = `${percent}%`;
    }

    async function loadData() {
        const kelas = document.getElementById('pilihKelas').value;
        const mapel = document.getElementById('pilihMapel').value;
        const semester = document.getElementById('pilihSemester').value;

        if (!kelas) return alert("Pilih kelas dulu!");

        // Update labels
        updateStsLabels();

        document.getElementById('loading').style.display = 'block';
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '';
        document.getElementById('summaryBox').style.display = 'none';

        try {
            const siswaSnap = await get(ref(db, `siswa/${kelas}`));
            if (!siswaSnap.exists()) {
                document.getElementById('loading').style.display = 'none';
                tbody.innerHTML = '<tr><td colspan="16">Data siswa belum ada.</td></tr>';
                return;
            }

            // 1. Ambil data dari admin_rekap (data realtime yang sudah disinkronkan)
            const adminData = await getAdminRekapData(semester, kelas, mapel);
            
            // 2. Ambil data dari database nilai (untuk fallback)
            const nilaiRef = ref(db, `nilai/${mapel}/${kelas}`);
            const nilaiSnap = await get(nilaiRef);
            const dataNilai = nilaiSnap.exists() ? nilaiSnap.val() : {};
            
            // 3. Hitung absensi terbaru
            const rekapAbsen = await hitungRekapAbsensi(kelas, semester, mapel);

            const siswaList = Object.values(siswaSnap.val()).sort((a,b) => a.nama.localeCompare(b.nama));
            let no = 1;
            let totalNilai = 0;
            let jumlahSiswaBerhasil = 0;
            let nilaiTertinggi = 0;
            let nilaiTerendah = 100;
            const nilaiArray = [];

            siswaList.forEach(siswa => {
                const safeId = siswa.nama.replace(/[.#$/[\]]/g, '_');
                
                let nilai = {};
                let absensi = { s: 0, i: 0, a: 0 };
                let nilaiAkhir = { nilai: 0, huruf: 'E', keterangan: 'Belum ada nilai' };
                let isRealtime = false;
                let detailPenalti = { penaltiAlfa: 0, penaltiIzin: 0 };
                
                // Prioritaskan data dari admin_rekap jika ada
                if (adminData[safeId]) {
                    nilai = {
                        s1: adminData[safeId].nilai_s1,
                        s2: adminData[safeId].nilai_s2,
                        s3: adminData[safeId].nilai_s3,
                        s4: adminData[safeId].nilai_s4,
                        sts: adminData[safeId].nilai_sts,
                        nilai_akhir: adminData[safeId].nilai_akhir,
                        nilai_huruf: adminData[safeId].nilai_huruf,
                        nilai_keterangan: adminData[safeId].nilai_keterangan,
                        penalti_kehadiran: adminData[safeId].penalti_kehadiran,
                        rata_subtest: adminData[safeId].rata_subtest,
                        nilai_sumatif: adminData[safeId].nilai_sumatif
                    };
                    absensi = {
                        s: adminData[safeId].absensi_sakit || rekapAbsen[safeId]?.s || 0,
                        i: adminData[safeId].absensi_ijin || rekapAbsen[safeId]?.i || 0,
                        a: adminData[safeId].absensi_alfa || rekapAbsen[safeId]?.a || 0
                    };
                    
                    // Ambil detail penalti jika ada
                    if (adminData[safeId].detail) {
                        detailPenalti = {
                            penaltiAlfa: adminData[safeId].detail.penaltiAlfa || 0,
                            penaltiIzin: adminData[safeId].detail.penaltiIzin || 0
                        };
                    }
                    
                    if (nilai.nilai_akhir) {
                        nilaiAkhir = {
                            nilai: nilai.nilai_akhir,
                            huruf: nilai.nilai_huruf || 'E',
                            keterangan: nilai.nilai_keterangan || 'Tidak ada keterangan'
                        };
                    }
                    
                    isRealtime = true;
                } else {
                    // Fallback ke data lama
                    nilai = (dataNilai[safeId] && dataNilai[safeId][semester]) ? dataNilai[safeId][semester] : {};
                    absensi = rekapAbsen[safeId] || { s: 0, i: 0, a: 0 };
                }
                
                // Hitung nilai akhir jika belum ada
                if (!nilaiAkhir.nilai || nilaiAkhir.nilai === 0) {
                    const s1 = nilai.s1 || 0;
                    const s2 = nilai.s2 || 0;
                    const s3 = nilai.s3 || 0;
                    const s4 = nilai.s4 || 0;
                    const sts = nilai.sts || 0;
                    const sakit = absensi.s || 0;
                    const ijin = absensi.i || 0;
                    const alfa = absensi.a || 0;
                    
                    const hasil = hitungNilaiAkhir(s1, s2, s3, s4, sts, sakit, ijin, alfa, semester);
                    nilaiAkhir = {
                        nilai: hasil.nilai,
                        huruf: hasil.huruf,
                        keterangan: hasil.keterangan
                    };
                    
                    // Simpan detail penalti
                    detailPenalti = hasil.detail || { penaltiAlfa: 0, penaltiIzin: 0 };
                }
                
                // Hitung total untuk summary
                if (nilaiAkhir.nilai > 0) {
                    totalNilai += nilaiAkhir.nilai;
                    nilaiArray.push(nilaiAkhir.nilai);
                    jumlahSiswaBerhasil++;
                    
                    if (nilaiAkhir.nilai > nilaiTertinggi) nilaiTertinggi = nilaiAkhir.nilai;
                    if (nilaiAkhir.nilai < nilaiTerendah) nilaiTerendah = nilaiAkhir.nilai;
                }
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${no++}</td>
                    <td style="text-align:left; font-weight:500;">
                        ${siswa.nama}
                        ${isRealtime ? '<span class="realtime-badge">REALTIME</span>' : ''}
                    </td>
                    <td>${nilai.s1 || '-'}</td>
                    <td>${nilai.s2 || '-'}</td>
                    <td>${nilai.s3 || '-'}</td>
                    <td>${nilai.s4 || '-'}</td>
                    <td style="font-weight:bold;">${nilai.sts || '-'}</td>
                    <td><span class="badge-absen bg-s">${absensi.s}</span></td>
                    <td><span class="badge-absen bg-i">${absensi.i}</span></td>
                    <td><span class="badge-absen bg-a">${absensi.a}</span></td>
                    <td class="nilai-akhir-cell" style="font-weight: 700; font-size: 15px; color: ${getColorFromGrade(nilaiAkhir.huruf)};">
                        ${nilaiAkhir.nilai.toFixed(2)}
                    </td>
                    <td class="nilai-akhir-cell">
                        <span class="grade-badge grade-${nilaiAkhir.huruf}">${nilaiAkhir.huruf}</span>
                </td>
                    <td class="nilai-akhir-cell" style="font-size: 12px; color: #64748b;">
                        ${nilaiAkhir.keterangan}
                    </td>
                    <td style="color: #dc2626; font-weight: 600;">${detailPenalti.penaltiAlfa.toFixed(2)}%</td>
                    <td style="color: #2563eb; font-weight: 600;">${detailPenalti.penaltiIzin.toFixed(2)}%</td>
                `;
                tbody.appendChild(tr);
            });

            // Update summary box
            if (jumlahSiswaBerhasil > 0) {
                const rataNilai = totalNilai / jumlahSiswaBerhasil;
                document.getElementById('totalSiswa').textContent = siswaList.length;
                document.getElementById('rataNilai').textContent = rataNilai.toFixed(2);
                document.getElementById('nilaiTertinggi').textContent = nilaiTertinggi.toFixed(2);
                document.getElementById('nilaiTerendah').textContent = nilaiTerendah.toFixed(2);
                document.getElementById('summaryBox').style.display = 'block';
            }

            showStatus(`Data berhasil dimuat: ${siswaList.length} siswa`, 'success');

        } catch (error) {
            console.error(error);
            showStatus("Gagal memuat data: " + error.message, 'error');
        } finally {
            document.getElementById('loading').style.display = 'none';
        }
    }

    // ========== FUNGSI RESET NILAI YANG AMAN ==========

    // 1. RESET SOFT: Set nilai ke 0/null (TANPA menghapus)
    async function resetNilaiSoft() {
        const kelas = document.getElementById('pilihKelas').value;
        const mapel = document.getElementById('pilihMapel').value;
        const semester = document.getElementById('pilihSemester').value;

        if (!kelas) return alert("Pilih Kelas, Mapel, dan Semester!");

        if(!confirm(`RESET SOFT (Set ke 0)\n\nAnda akan mengatur ulang nilai untuk:\n‚Ä¢ Mata Pelajaran: ${mapel.toUpperCase()}\n‚Ä¢ Kelas: ${kelas}\n‚Ä¢ Semester: ${semester.toUpperCase()}\n\nNilai akan diatur ke 0/kosong, data TIDAK dihapus.\n\nLanjutkan?`)) {
            return;
        }

        // Tampilkan loading dan progress bar
        document.getElementById('loading').style.display = 'block';
        document.getElementById('resetProgress').style.display = 'block';
        updateProgressBar(0);
        showStatus("Memulai Reset Soft (Set nilai ke 0)...", 'warning');
        
        try {
            const siswaSnap = await get(ref(db, `siswa/${kelas}`));
            if (!siswaSnap.exists()) {
                showStatus("Tidak ada data siswa", 'warning');
                return;
            }

            const siswaList = Object.values(siswaSnap.val());
            let successCount = 0;
            let errorCount = 0;
            
            // Reset untuk setiap siswa
            for (let i = 0; i < siswaList.length; i++) {
                const siswa = siswaList[i];
                const safeId = siswa.nama.replace(/[.#$/[\]]/g, '_');
                
                // Update progress bar
                updateProgressBar(Math.round((i / siswaList.length) * 100));
                
                try {
                    // 1. Reset di database nilai utama (menggunakan SET ke null)
                    const dataKosong = {
                        s1: null,
                        s2: null,
                        s3: null,
                        s4: null,
                        sts: null,
                        sakit: 0,
                        ijin: 0,
                        alfa: 0,
                        nama_siswa: siswa.nama,
                        kelas: kelas,
                        mata_pelajaran: mapel,
                        semester: semester,
                        last_updated: new Date().toISOString(),
                        updated_by: currentUserEmail || 'admin'
                    };
                    
                    // Gunakan set() untuk membuat/update data
                    await set(ref(db, `nilai/${mapel}/${kelas}/${safeId}/${semester}`), dataKosong);
                    
                    // 2. Update admin_rekap dengan nilai kosong
                    const dataAdminKosong = {
                        nilai_s1: null,
                        nilai_s2: null,
                        nilai_s3: null,
                        nilai_s4: null,
                        nilai_sts: null,
                        absensi_sakit: 0,
                        absensi_ijin: 0,
                        absensi_alfa: 0,
                        nilai_akhir: 0,
                        nilai_huruf: 'E',
                        nilai_keterangan: 'Belum ada nilai',
                        rata_subtest: 0,
                        nilai_sumatif: 0,
                        penalti_kehadiran: 0,
                        jumlah_absen: 0,
                        nama_siswa: siswa.nama,
                        kelas: kelas,
                        mata_pelajaran: mapel,
                        semester: semester,
                        guru_pencatat: currentUserEmail || 'admin',
                        last_sync: new Date().toISOString(),
                        sync_timestamp: Date.now()
                    };
                    
                    await set(ref(db, `admin_rekap/nilai/${semester}/${kelas}/${mapel}/${safeId}`), dataAdminKosong);
                    
                    successCount++;
                    console.log(`‚úÖ Reset soft untuk ${siswa.nama}`);
                    
                } catch (error) {
                    errorCount++;
                    console.error(`‚ùå Gagal reset ${siswa.nama}:`, error);
                }
            }
            
            updateProgressBar(100);
            
            if (errorCount === 0) {
                showStatus(`‚úÖ Reset Soft Berhasil! ${successCount} data direset ke 0`, 'success');
            } else {
                showStatus(`‚ö† Reset Soft selesai. ${successCount} berhasil, ${errorCount} gagal`, 'warning');
            }
            
            // Refresh tampilan
            setTimeout(() => {
                loadData();
            }, 1500);
            
        } catch (error) {
            console.error("Error reset soft:", error);
            showStatus(`‚ùå Gagal reset soft: ${error.message}`, 'error');
        } finally {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('resetProgress').style.display = 'none';
        }
    }

    // 2. RESET HARD: Coba hapus data (jika ada permission)
    async function resetNilaiHard() {
        const kelas = document.getElementById('pilihKelas').value;
        const mapel = document.getElementById('pilihMapel').value;
        const semester = document.getElementById('pilihSemester').value;

        if (!kelas) return alert("Pilih Kelas, Mapel, dan Semester!");

        if(!confirm(`üö® RESET HARD (Hapus Data) üö®\n\nPERINGATAN TINGGI!\n\nAnda akan MENGHAPUS data nilai untuk:\n‚Ä¢ Mata Pelajaran: ${mapel.toUpperCase()}\n‚Ä¢ Kelas: ${kelas}\n‚Ä¢ Semester: ${semester.toUpperCase()}\n\nData yang dihapus TIDAK BISA DIKEMBALIKAN!\n\nYakin ingin melanjutkan?`)) {
            return;
        }

        // Tampilkan loading dan progress bar
        document.getElementById('loading').style.display = 'block';
        document.getElementById('resetProgress').style.display = 'block';
        updateProgressBar(0);
        showStatus("Memulai Reset Hard (Hapus data)...", 'warning');
        
        try {
            // Check permission terlebih dahulu
            const hasDeletePermission = await checkDeletePermission(currentUserId);
            if (!hasDeletePermission) {
                throw new Error("Anda tidak memiliki izin untuk menghapus data. Akan dilakukan Reset Soft sebagai alternatif.");
            }
            
            const siswaSnap = await get(ref(db, `siswa/${kelas}`));
            if (!siswaSnap.exists()) {
                showStatus("Tidak ada data siswa", 'warning');
                return;
            }

            const siswaList = Object.values(siswaSnap.val());
            let successCount = 0;
            let errorCount = 0;
            
            // Coba hapus untuk setiap siswa
            for (let i = 0; i < siswaList.length; i++) {
                const siswa = siswaList[i];
                const safeId = siswa.nama.replace(/[.#$/[\]]/g, '_');
                
                // Update progress bar
                updateProgressBar(Math.round((i / siswaList.length) * 100));
                
                try {
                    // 1. Coba hapus dari database nilai utama
                    const nilaiRef = ref(db, `nilai/${mapel}/${kelas}/${safeId}/${semester}`);
                    await set(nilaiRef, null); // Menggunakan set(null) untuk menghapus
                    
                    // 2. Coba hapus dari admin_rekap
                    const adminRef = ref(db, `admin_rekap/nilai/${semester}/${kelas}/${mapel}/${safeId}`);
                    await set(adminRef, null); // Menggunakan set(null) untuk menghapus
                    
                    successCount++;
                    console.log(`‚úÖ Hapus data untuk ${siswa.nama}`);
                    
                } catch (error) {
                    errorCount++;
                    console.error(`‚ùå Gagal hapus ${siswa.nama}:`, error);
                    
                    // Jika gagal hapus, coba reset soft sebagai fallback
                    try {
                        await fallbackResetSoft(siswa, safeId, kelas, mapel, semester);
                        successCount++;
                        console.log(`‚úÖ Fallback reset soft untuk ${siswa.nama}`);
                    } catch (fallbackError) {
                        console.error(`‚ùå Gagal fallback untuk ${siswa.nama}:`, fallbackError);
                    }
                }
            }
            
            updateProgressBar(100);
            
            if (errorCount === 0) {
                showStatus(`‚úÖ Reset Hard Berhasil! ${successCount} data dihapus`, 'success');
            } else {
                showStatus(`‚ö† Reset Hard selesai. ${successCount} berhasil, ${errorCount} gagal (beberapa menggunakan fallback)`, 'warning');
            }
            
            // Refresh tampilan
            setTimeout(() => {
                loadData();
            }, 1500);
            
        } catch (error) {
            console.error("Error reset hard:", error);
            
            // Jika permission denied, tawarkan reset soft sebagai alternatif
            if (error.message.includes("PERMISSION_DENIED") || error.message.includes("izin")) {
                if (confirm("Reset Hard gagal karena masalah izin.\n\nIngin mencoba Reset Soft sebagai alternatif?")) {
                    await resetNilaiSoft();
                }
            } else {
                showStatus(`‚ùå Gagal reset hard: ${error.message}`, 'error');
            }
        } finally {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('resetProgress').style.display = 'none';
        }
    }

    // 3. RESET AMAN: Tombol utama (menggunakan reset soft sebagai default)
    async function resetNilaiAman() {
        if (!document.getElementById('confirmReset').checked) {
            return alert("Harap centang konfirmasi terlebih dahulu!");
        }
        
        // Default ke reset soft (lebih aman)
        await resetNilaiSoft();
        
        // Reset checkbox
        document.getElementById('confirmReset').checked = false;
        document.getElementById('btnReset').disabled = true;
    }

    // Helper: Fallback reset soft jika hard reset gagal
    async function fallbackResetSoft(siswa, safeId, kelas, mapel, semester) {
        const dataKosong = {
            s1: null,
            s2: null,
            s3: null,
            s4: null,
            sts: null,
            sakit: 0,
            ijin: 0,
            alfa: 0,
            nama_siswa: siswa.nama,
            kelas: kelas,
            mata_pelajaran: mapel,
            semester: semester,
            last_updated: new Date().toISOString(),
            updated_by: currentUserEmail || 'admin'
        };
        
        await set(ref(db, `nilai/${mapel}/${kelas}/${safeId}/${semester}`), dataKosong);
        
        const dataAdminKosong = {
            nilai_s1: null,
            nilai_s2: null,
            nilai_s3: null,
            nilai_s4: null,
            nilai_sts: null,
            absensi_sakit: 0,
            absensi_ijin: 0,
            absensi_alfa: 0,
            nilai_akhir: 0,
            nilai_huruf: 'E',
            nilai_keterangan: 'Belum ada nilai',
            rata_subtest: 0,
            nilai_sumatif: 0,
            penalti_kehadiran: 0,
            jumlah_absen: 0,
            nama_siswa: siswa.nama,
            kelas: kelas,
            mata_pelajaran: mapel,
            semester: semester,
            guru_pencatat: currentUserEmail || 'admin',
            last_sync: new Date().toISOString(),
            sync_timestamp: Date.now()
        };
        
        await set(ref(db, `admin_rekap/nilai/${semester}/${kelas}/${mapel}/${safeId}`), dataAdminKosong);
    }

    async function syncOldData() {
        const kelas = document.getElementById('pilihKelas').value;
        const mapel = document.getElementById('pilihMapel').value;
        const semester = document.getElementById('pilihSemester').value;
        
        if (!kelas || !mapel || !semester) {
            return alert("Pilih filter terlebih dahulu");
        }
        
        if (!confirm("Sinkronisasi data lama dari database nilai ke admin_rekap?\n\nData yang sudah ada di admin_rekap tidak akan diubah.")) {
            return;
        }
        
        document.getElementById('loading').style.display = 'block';
        
        try {
            const result = await syncAllOldData(mapel, kelas, semester);
            
            if (result.success) {
                alert(`Berhasil sinkronisasi ${result.count} data nilai ke admin_rekap!`);
                loadData();
            } else {
                alert("Gagal sinkronisasi: " + (result.message || result.error));
            }
            
        } catch (error) {
            alert("Error sinkronisasi: " + error.message);
        } finally {
            document.getElementById('loading').style.display = 'none';
        }
    }

    function exportExcel() {
        const table = document.getElementById("nilaiTable");
        const kelas = document.getElementById('pilihKelas').value;
        const mapel = document.getElementById('pilihMapel').value;
        const semester = document.getElementById('pilihSemester').value;
        
        if(!kelas) return alert("Tampilkan data dulu!");
        
        const fileName = `Rekap_Nilai_${kelas}_${mapel}_${semester}_${new Date().toISOString().split('T')[0]}.xlsx`;
        
        const wb = XLSX.utils.table_to_book(table, {sheet: "Rekap Nilai"});
        XLSX.writeFile(wb, fileName);
    }
</script>

</body>
</html>
